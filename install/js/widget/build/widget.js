this.BX=this.BX||{},function(e){"use strict";var t=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"getFactory",value:function(e){var t,n,r,o,i;if(null==e)return null;var a,s=null===(t=window)||void 0===t||null===(n=t.BX)||void 0===n||null===(r=n.YandexPay)||void 0===r||null===(o=r.Solution)||void 0===o||null===(i=o[e])||void 0===i?void 0:i.factory;if(null!=s)return s;null===(a=console)||void 0===a||a.warn("cant find solution ".concat(e))}},{key:"getPage",value:function(e,t){if(null==e||null==t)return null;var n=e+":"+t;return null==this.pages[n]&&(this.pages[n]=this.createPage(e,t)),this.pages[n]}},{key:"createPage",value:function(e,t){var n=this.getFactory(e);return null==n?null:n.create(t)}}]),e}();babelHelpers.defineProperty(t,"pages",{});var n=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};babelHelpers.classCallCheck(this,e),this.el=t,this.options=Object.assign({},this.constructor.defaults,n)}return babelHelpers.createClass(e,[{key:"destroy",value:function(){}}]),e}();babelHelpers.defineProperty(n,"defaults",{check:null});var r=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return babelHelpers.classCallCheck(this,t),n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,r)),babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"loop",(function(){n.options.check()&&n.loopTimeout()})),n.loopTimeout(),n}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"destroy",value:function(){this.loopCancel()}},{key:"loopTimeout",value:function(){clearTimeout(this._loopTimeout),this._loopTimeout=setTimeout(this.loop,this.options.timeout)}},{key:"loopCancel",value:function(){clearTimeout(this._loopTimeout)}}]),t}(n);function o(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw a}}}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}babelHelpers.defineProperty(r,"defaults",Object.assign({},n.defaults,{timeout:1e3}));var a=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return babelHelpers.classCallCheck(this,t),n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,r)),babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"listener",(function(e){var t,r=o(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(null!=i.removedNodes){var a,s=o(i.removedNodes);try{for(s.s();!(a=s.n()).done;){var l=a.value;if(l instanceof HTMLElement&&(l===n.el||l.contains(n.el)))return void n.runCheck()}}catch(e){s.e(e)}finally{s.f()}}}}catch(e){r.e(e)}finally{r.f()}})),n.observe(),n}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"destroy",value:function(){this.disconnect()}},{key:"observe",value:function(){var e,t=this.getAnchor();null!=t?(this.observer=new window.MutationObserver(this.listener),this.observer.observe(t,{childList:!0,subtree:!0})):null===(e=console)||void 0===e||e.warn("cant find anchor for node preserver")}},{key:"disconnect",value:function(){null!=this.observer&&(this.observer.disconnect(),this.observer=null)}},{key:"runCheck",value:function(){var e=this,t=this.options.delay;null==t?this.options.check():(clearTimeout(this._checkTimeout),this._checkTimeout=setTimeout((function(){e.options.check()}),t))}},{key:"getAnchor",value:function(){return null==this.options.anchor?document.body:this.el.closest(this.options.anchor)}}]),t}(n);babelHelpers.defineProperty(a,"defaults",Object.assign({},n.defaults,{anchor:null,delay:0}));var s=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"make",value:function(e,t){return"function"==typeof window.MutationObserver?new a(e,t):new r(e,t)}}]),e}(),l=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};babelHelpers.classCallCheck(this,e),this.el=t,this.options=Object.assign({},this.constructor.defaults,n),this.bind()}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.unbind(),this.options={},this.el=null}},{key:"bind",value:function(){var e;null!=this.options.on?this.options.on(this.options.check):null===(e=console)||void 0===e||e.warn('define "on" option for subscriber of node preserver')}},{key:"unbind",value:function(){var e;null!=this.options.off?this.options.off(this.options.check):null===(e=console)||void 0===e||e.warn('define "off" option for subscriber of node preserver')}}]),e}();babelHelpers.defineProperty(l,"defaults",{check:null,on:null,off:null});var u=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};babelHelpers.classCallCheck(this,e),babelHelpers.defineProperty(this,"check",(function(){var e=document.body.contains(n.el);return e||n.options.restore(),e})),this.el=t,this.options=Object.assign({},this.constructor.defaults,r),this.install()}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.uninstall(),this.options={},this.el=null}},{key:"install",value:function(){this.installMutation(),this.installSubscriber()}},{key:"uninstall",value:function(){this.uninstallMutation(),this.uninstallSubscriber()}},{key:"installMutation",value:function(){this.isEnabled("mutation")&&(this.mutation=s.make(this.el,this.driverOptions("mutation")))}},{key:"uninstallMutation",value:function(){null!=this.mutation&&this.mutation.destroy()}},{key:"installSubscriber",value:function(){this.isEnabled("subscriber")&&(this.subscriber=new l(this.el,this.driverOptions("subscriber")))}},{key:"uninstallSubscriber",value:function(){null!=this.subscriber&&(this.subscriber.destroy(),this.subscriber=null)}},{key:"isEnabled",value:function(e){return!!this.options[e]}},{key:"driverOptions",value:function(e){var t="object"===babelHelpers.typeof(this.options[e])?this.options[e]:{},n={check:this.check};return Object.assign({},t,n)}}]),e}();babelHelpers.defineProperty(u,"defaults",{restore:null,subscriber:null,mutation:!0});var c=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"compile",value:function(e,t){var n,r,o,i=e;for(n in t)if(t.hasOwnProperty(n)){r="#"+n.toUpperCase()+"#",o=t[n];do{i=i.replace(r,o)}while(-1!==i.indexOf(r))}return i}},{key:"toElement",value:function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}},{key:"toElements",value:function(e){var t=document.createElement("div");return t.innerHTML=e,babelHelpers.toConsumableArray(t.children)}}]),e}();function p(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,e),babelHelpers.defineProperty(this,"waitCount",0),this.defaults=Object.assign({},this.constructor.defaults),this.options={},this.setOptions(t),this.bootSolution()}return babelHelpers.createClass(e,[{key:"inject",value:function(e,t){var n=this;return Promise.resolve().then((function(){return n.waitElement(e)})).then((function(e){return n.checkElement(e)})).then((function(r){var o=n.renderElement(r,t),i=n.install(o);return n.getOption("preserve")&&n.preserve(e,t,i),i}))}},{key:"checkElement",value:function(e){var t=this.getOption("containerSelector");if(!!e.querySelector(t)||this.containsSiblingElement(e,t))throw new Error("the element already has a container");return e}},{key:"containsSiblingElement",value:function(e,t){for(var n,r=!1,o=null===(n=e.parentElement)||void 0===n?void 0:n.firstElementChild;o;){if(o.matches(t)||o.querySelector(t)){r=!0;break}o=o.nextElementSibling}return r}},{key:"preserve",value:function(e,t,n){var r=this,o=new u(n.el,Object.assign({},this.preserveOptions(),{restore:function(){o.destroy(),r.restore(e,t,n)}}))}},{key:"preserveOptions",value:function(){var e=this.getOption("preserve");return"object"===babelHelpers.typeof(e)?e:{}}},{key:"restore",value:function(e,t,n){var r=this;return Promise.resolve().then((function(){return r.waitElement(e)})).then((function(o){var i=r.renderElement(o,t);return n.restore(i),r.getOption("preserve")&&r.preserve(e,t,n),n}))}},{key:"install",value:function(e){return new BX.YandexPay.Widget(e)}},{key:"waitElement",value:function(e){var t=this;return new Promise((function(n,r){t.waitCount=0,t.waitElementLoop(e,n,r)}))}},{key:"waitElementLoop",value:function(e,t,n){var r=this.findElement(e);r?t(r):(++this.waitCount,this.waitCount>=this.getOption("waitLimit")?n("cant find element by selector "+e):setTimeout(this.waitElementLoop.bind(this,e,t,n),this.getOption("waitTimeout")))}},{key:"findElement",value:function(e){var t,n,r,o,i=e.trim();if(""===i)throw new Error("widget selector is empty");return null==(r=null!==(t=null!==(n=this.searchBySelector(i))&&void 0!==n?n:this.searchById(e))&&void 0!==t?t:this.searchByClassName(e))?null:(r.length>1&&(o=this.reduceVisible(r)),null==o&&(o=r[0]),o)}},{key:"searchBySelector",value:function(e){try{var t,n=[],r=p(e.split(","));try{for(r.s();!(t=r.n()).done;){var o=t.value.trim();if(""!==o&&this.isCssSelector(o)){var i,a=p(document.querySelectorAll(o));try{for(a.s();!(i=a.n()).done;){var s=i.value;n.push(s)}}catch(e){a.e(e)}finally{a.f()}}}}catch(e){r.e(e)}finally{r.f()}return n.length>0?n:null}catch(e){return null}}},{key:"searchById",value:function(e){try{var t=document.getElementById(e);return null!=t?[t]:null}catch(e){return null}}},{key:"searchByClassName",value:function(e){try{var t=document.getElementsByClassName(e);return t.length>0?t:null}catch(e){return null}}},{key:"reduceVisible",value:function(e){var t,n=null,r=p(e);try{for(r.s();!(t=r.n()).done;){var o=t.value;if(this.testVisible(o)){n=o;break}}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"testVisible",value:function(e){return e.offsetWidth||e.offsetHeight||e.getClientRects().length}},{key:"isCssSelector",value:function(e){return/^[.#]/.test(e)}},{key:"renderElement",value:function(e,t){var n=this.getOption("containerSelector"),r=this.getOption("buttonWidth")||YaPay.ButtonWidth.Auto,o=c.compile(this.getOption("template"),{label:this.getOption("label"),width:r.toLowerCase()}),i=c.toElements(o),a=null;0===t.indexOf("after")&&(i=i.reverse());var s,l=p(i);try{for(l.s();!(s=l.n()).done;){var u=s.value;e.insertAdjacentElement(t,u),null==a&&(a=u.matches(n)?u:u.querySelector(n))}}catch(e){l.e(e)}finally{l.f()}if(null==a)throw new Error("cant find template container by selector ".concat(n));return a}},{key:"bootSolution",value:function(){var e=this.getOption("solution"),n=this.getOption("mode"),r=t.getPage(e,n);null!=r&&r.bootFactory(this)}},{key:"extendDefaults",value:function(e){this.defaults=Object.assign(this.defaults,e)}},{key:"setOptions",value:function(e){this.options=Object.assign(this.options,e)}},{key:"getOption",value:function(e){var t;return null!==(t=this.options[e])&&void 0!==t?t:this.defaults[e]}}]),e}();babelHelpers.defineProperty(y,"defaults",{solution:null,template:'<div id="yandexpay" class="bx-yapay-drawer"></div>',containerSelector:".bx-yapay-drawer",preserve:!1,waitLimit:30,waitTimeout:1e3});var d=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};babelHelpers.classCallCheck(this,e),babelHelpers.defineProperty(this,"delayTimeouts",{}),this.widget=t,this.defaults=Object.assign({},this.constructor.defaults),this.options=Object.assign({},n)}return babelHelpers.createClass(e,[{key:"getOption",value:function(e){var t,n;return null!==(t=null!==(n=this.options[e])&&void 0!==n?n:this.widget.getOption(e))&&void 0!==t?t:this.defaults[e]}},{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.innerHTML=this.compile(t)}},{key:"compile",value:function(e){return c.compile(this.getOption("template"),e)}},{key:"restore",value:function(e){}},{key:"query",value:function(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((function(e){return e.json()}))}},{key:"getTemplate",value:function(e){var t=e+"Template",n=this.options[t],r=n.substr(0,1);return"."===r||"#"===r?this.getNode(n).innerHTML:n}},{key:"getElement",value:function(e,t,n){var r=this.getElementSelector(e);return this.getNode(r,t,n||"querySelector")}},{key:"getElementSelector",value:function(e){var t=e+"Element";return this.options[t]}},{key:"getNode",value:function(e,t,n){return"#"===e.substr(0,1)?t=document:t||(t=this.el),t[n](e)}},{key:"clearDelay",value:function(e){null!=this.delayTimeouts[e]&&(clearTimeout(this.delayTimeouts[e]),this.delayTimeouts[e]=null)}},{key:"delay",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300;this.clearDelay(e),this.delayTimeouts[e]=setTimeout((t=this[e]).bind.apply(t,[this].concat(babelHelpers.toConsumableArray(n))),r)}}]),e}();babelHelpers.defineProperty(d,"defaults",{template:""});var f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,e),this.options=Object.assign({},this.constructor.defaults,t),this.widget=null}return babelHelpers.createClass(e,[{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.innerHTML=this.compile(t)}},{key:"compile",value:function(e){return c.compile(this.options.template,e)}},{key:"setWidget",value:function(e){this.widget=e}},{key:"getOption",value:function(e){return e in this.options?this.options[e]:this.widget.options[e]}}]),e}();babelHelpers.defineProperty(f,"defaults",{template:null});var m=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"render",this).call(this,e,n),this.autosubmit(e)}},{key:"compile",value:function(e){var t=this.options.template,n=Object.assign(e,{inputs:this.makeInputs(e)});return c.compile(t,n)}},{key:"makeInputs",value:function(e){var t,n,r=e.params;if(0===Object.keys(r).length)return"";for(t in n=e.termUrl?'<input type="hidden" name="TermUrl" value="'+r.termUrl+'">':"",r)r.hasOwnProperty(t)&&(n+='<input type="hidden" name="'+t+'" value="'+r[t]+'">');return n}},{key:"makeTermUrl",value:function(){var e=this.getOption("notifyUrl"),t=window.location.href;return e+=(-1===e.indexOf("?")?"?":"&")+"backurl="+encodeURIComponent(t)+"&service="+this.getOption("requestSign")+"&paymentId="+this.getOption("externalId")}},{key:"autosubmit",value:function(e){e.querySelector("form").submit()}}]),t}(f);babelHelpers.defineProperty(m,"defaults",{template:'<form name="form" action="#ACTION#" method="#METHOD#">#INPUTS#</form>'});var b=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,t){this.insertIframe(e,t)}},{key:"insertIframe",value:function(e,t){e.innerHTML=c.compile(this.options.template,t),this.compile(e,t)}},{key:"compile",value:function(e,t){var n=e.querySelector("iframe"),r=n.contentWindow||n.contentDocument.document||n.contentDocument,o=t.params;r.document.open(),r.document.write(o),r.document.close()}}]),t}(f);babelHelpers.defineProperty(b,"defaults",{template:'<iframe style="display: none;"></iframe>'});var v=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,t){this.insertIframe(e,t)}},{key:"insertIframe",value:function(e,t){e.innerHTML=c.compile(this.options.template,t),this.compile(e,t)}},{key:"compile",value:function(e,t){var n=this;Promise.resolve().then((function(){return n.renderIframe(e,t)})).then((function(){return n.query(t)}))}},{key:"query",value:function(e){var t=this;fetch(this.getOption("notifyUrl"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:this.getOption("requestSign"),accept:"json",secure:e.params.secure,externalId:e.params.notify.externalId,paySystemId:e.params.notify.paySystemId})}).then((function(e){return e.json()})).then((function(e){!0===e.success?t.widget.go(e.state,e):t.widget.go("error",e)})).catch((function(e){return console.log(e)}))}},{key:"renderIframe",value:function(e,t){var n=e.querySelector("iframe"),r=n.contentWindow||n.contentDocument.document||n.contentDocument,o='<form name="form" action="'.concat(t.action,'" method="POST">');r.document.open(),r.document.write(o),r.document.close(),r.document.querySelector("form").submit()}}]),t}(f);babelHelpers.defineProperty(v,"defaults",{template:'<iframe style="display: none;"></iframe>'});var g=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,t){var n=this.makeView(t);n.setWidget(this.widget),n.render(e,t)}},{key:"makeView",value:function(e){var t=e.view;if("form"===t)return new m;if("iframe"===t)return new b;if("iframerbs"===t)return new v;throw new Error("view secure3d missing")}}]),t}(d),k=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),t}(d);babelHelpers.defineProperty(k,"defaults",{template:'<div class="alert alert-success" role="alert"><strong>#MESSAGE#</strong></div>'});var O=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),t}(d);babelHelpers.defineProperty(O,"defaults",{template:'<div class="alert alert-danger" role="alert"><strong>#MESSAGE#</strong></div>'});var C=window.YaPay,w=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,t){var n=this.getPaymentData(t);this.createPayment(e,n)}},{key:"compile",value:function(e){return c.compile(this.options.template,e)}},{key:"getPaymentData",value:function(e){return{env:this.getOption("env"),version:2,countryCode:C.CountryCode.Ru,currencyCode:C.CurrencyCode.Rub,merchant:{id:this.getOption("merchantId"),name:this.getOption("merchantName")},order:{id:e.id,total:{amount:e.total},items:e.items},paymentMethods:[{type:C.PaymentMethodType.Card,gateway:this.getOption("gateway"),gatewayMerchantId:this.getOption("gatewayMerchantId"),allowedAuthMethods:[C.AllowedAuthMethod.PanOnly],allowedCardNetworks:[C.AllowedCardNetwork.UnionPay,C.AllowedCardNetwork.Uzcard,C.AllowedCardNetwork.Discover,C.AllowedCardNetwork.AmericanExpress,C.AllowedCardNetwork.Visa,C.AllowedCardNetwork.Mastercard,C.AllowedCardNetwork.Mir,C.AllowedCardNetwork.Maestro,C.AllowedCardNetwork.VisaElectron]}]}}},{key:"createPayment",value:function(e,t){var n=this;C.createPayment(t,{agent:{name:"CMS-Bitrix",version:"1.0"}}).then((function(t){var r=t.createButton({type:C.ButtonType.Pay,theme:n.getOption("buttonTheme")||C.ButtonTheme.Black,width:n.getOption("buttonWidth")||C.ButtonWidth.Auto});r.mount(e),r.on(C.ButtonEventType.Click,(function(){t.checkout()})),t.on(C.PaymentEventType.Process,(function(e){n.notify(t,e).then((function(e){})),t.complete(C.CompleteReason.Success)})),t.on(C.PaymentEventType.Error,(function(e){console.log({errors:e}),t.complete(C.CompleteReason.Error)})),t.on(C.PaymentEventType.Abort,(function(e){}))})).catch((function(e){console.log({"payment not create":e})}))}},{key:"notify",value:function(e,t){var n=this;return fetch(this.getOption("notifyUrl"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:this.getOption("requestSign"),accept:"json",yandexData:t,externalId:this.getOption("externalId"),paySystemId:this.getOption("paySystemId")})}).then((function(e){return e.json()})).then((function(e){!0===e.success?n.widget.go(e.state,e):n.widget.go("error",e)})).catch((function(e){return console.log(e)}))}}]),t}(d);babelHelpers.defineProperty(w,"defaults",{template:'<div class="alert alert-success" role="alert"><strong>#MESSAGE#</strong></div>'});var P=function(){function e(t){babelHelpers.classCallCheck(this,e),this.cart=t}return babelHelpers.createClass(e,[{key:"getOption",value:function(e){return this.cart.getOption(e)}},{key:"bootstrap",value:function(){}},{key:"createPayment",value:function(e,t){}},{key:"getPaymentData",value:function(){}}]),e}();function H(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?H(Object(n),!0).forEach((function(t){babelHelpers.defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):H(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var E=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"bootstrap",value:function(){var e=this;this.getButtonData().then((function(t){if("fail"===t.status)throw new Error(t.reason);e.combineOrderWithData(t.data),e.createPayment(e.cart.element,e.cart.paymentData)})).catch((function(e){}))}},{key:"getButtonData",value:function(){var e={productId:this.getOption("productId"),mode:this.getOption("mode"),currencyCode:this.getOption("currencyCode"),setupId:this.getOption("setupId")};return this.cart.query(this.getOption("restUrl")+"button/data",e)}},{key:"getPaymentData",value:function(){return{env:this.getOption("env"),version:3,merchantId:this.getOption("merchantId"),cart:{externalId:"checkout-b2b-test-order-id"},currencyCode:this.getOption("currencyCode")}}},{key:"createPayment",value:function(e,t){var n=this;console.log(t),YaPay.createCheckout(t,{agent:{name:"CMS-Bitrix",version:"1.0"}}).then((function(t){n.cart.removeLoader(),n.mountButton(e,t),t.on(YaPay.CheckoutEventType.Success,(function(e){n.authorize(e).then((function(e){"success"===e.status?setTimeout((function(){window.location.href=e.data.redirect}),1e3):n.cart.showError("authorize",e.reasonCode,e.reason)})),t.complete(YaPay.CompleteReason.Success),console.log("Process",e)})),t.on(YaPay.CheckoutEventType.Error,(function(e){console.log("Process",e)}))})).catch((function(t){e.remove(),n.cart.showError("yapayPayment","payment not created",t)}))}},{key:"authorize",value:function(e){var t={orderId:e.orderId,hash:e.metadata,successUrl:this.getOption("successUrl")};return this.cart.query(this.getOption("restUrl")+"authorize",t)}},{key:"bindDebug",value:function(e){for(var t in YaPay.CheckoutEventType)YaPay.CheckoutEventType.hasOwnProperty(t)&&e.on(YaPay.CheckoutEventType[t],(function(){console.log(arguments)}))}},{key:"mountButton",value:function(e,t){this.payment=t,t.mountButton(this.cart.element,{type:YaPay.ButtonType.Checkout,theme:this.getOption("buttonTheme")||YaPay.ButtonTheme.Black,width:this.getOption("buttonWidth")||YaPay.ButtonWidth.Auto})}},{key:"restoreButton",value:function(e){null!=this.payment?this.payment.mountButton(e,{type:YaPay.ButtonType.Checkout,theme:this.getOption("buttonTheme")||YaPay.ButtonTheme.Black,width:this.getOption("buttonWidth")||YaPay.ButtonWidth.Auto}):this.cart.insertLoader()}},{key:"combineOrderWithData",value:function(e){var t={cart:S(S({},this.cart.paymentData.cart),{},{items:e.items,total:{amount:e.total.amount}}),metadata:e.metadata};Object.assign(this.cart.paymentData,t)}},{key:"changeOffer",value:function(e){var t=this;this.getOption("productId")!==e&&(this.cart.widget.setOptions({productId:e}),this.getButtonData().then((function(e){t.combineOrderWithData(e.data)})))}},{key:"changeBasket",value:function(){var e=this;this.getButtonData().then((function(t){e.combineOrderWithData(t.data)}))}}]),t}(P);function T(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?T(Object(n),!0).forEach((function(t){babelHelpers.defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):T(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var B=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"bootstrap",value:function(){var e=this;this.getProducts().then((function(t){if(t.error)throw new Error(t.error.message);e.combineOrderWithProducts(t),e.createPayment(e.cart.element,e.cart.paymentData)})).catch((function(e){}))}},{key:"getPaymentData",value:function(){return{env:this.getOption("env"),version:2,countryCode:YaPay.CountryCode.Ru,currencyCode:YaPay.CurrencyCode.Rub,merchant:{id:this.getOption("merchantId"),name:this.getOption("merchantName"),url:this.getOption("siteUrl")},order:{id:"0"},paymentMethods:[{type:YaPay.PaymentMethodType.Card,gateway:this.getOption("gateway"),gatewayMerchantId:this.getOption("gatewayMerchantId"),allowedAuthMethods:[YaPay.AllowedAuthMethod.PanOnly],allowedCardNetworks:[YaPay.AllowedCardNetwork.UnionPay,YaPay.AllowedCardNetwork.Uzcard,YaPay.AllowedCardNetwork.Discover,YaPay.AllowedCardNetwork.AmericanExpress,YaPay.AllowedCardNetwork.Visa,YaPay.AllowedCardNetwork.Mastercard,YaPay.AllowedCardNetwork.Mir,YaPay.AllowedCardNetwork.Maestro,YaPay.AllowedCardNetwork.VisaElectron]}],requiredFields:{billingContact:{email:this.getOption("useEmail")||!1},shippingContact:{name:this.getOption("useName")||!1,email:this.getOption("useEmail")||!1,phone:this.getOption("usePhone")||!1},shippingTypes:{direct:!0,pickup:!0}}}}},{key:"getProducts",value:function(){var e={yapayAction:"getProducts",productId:this.getOption("productId"),mode:this.getOption("mode"),setupId:this.getOption("setupId")};return this.cart.query(this.getOption("purchaseUrl"),e)}},{key:"getShippingOptions",value:function(e){var t={address:e,yapayAction:"deliveryOptions",items:this.cart.paymentData.order.items,setupId:this.getOption("setupId")};return this.cart.query(this.getOption("purchaseUrl"),t)}},{key:"getPickupOptions",value:function(e){var t={bounds:e,yapayAction:"pickupOptions",items:this.cart.paymentData.order.items,setupId:this.getOption("setupId")};return this.cart.query(this.getOption("purchaseUrl"),t)}},{key:"createPayment",value:function(e,t){var n=this;YaPay.createPayment(t,{agent:{name:"CMS-Bitrix",version:"1.0"}}).then((function(t){n.cart.removeLoader(),n.cart.mountButton(e,t),t.on(YaPay.PaymentEventType.Process,(function(e){n.orderAccept(e).then((function(r){if(r.error)throw new Error(r.error.message,r.error.code);n.isPaymentTypeCash(e)?(t.complete(YaPay.CompleteReason.Success),null!=r.redirect&&(window.location.href=r.redirect)):n.notify(r,e).then((function(e){!0===e.success?(n.cart.widget.go(e.state,e),t.complete(YaPay.CompleteReason.Success)):(n.cart.widget.go("error",e),t.complete(YaPay.CompleteReason.Error))}))})).catch((function(e){n.cart.showError("yapayProcess","",e),t.complete(YaPay.CompleteReason.Error)}))})),t.on(YaPay.PaymentEventType.Error,(function(e){n.cart.showError("yapayError","service temporary unavailable"),t.complete(YaPay.CompleteReason.Error)})),t.on(YaPay.PaymentEventType.Change,(function(e){e.shippingAddress&&n.getShippingOptions(e.shippingAddress).then((function(e){t.update({shippingOptions:e})})),e.shippingOption&&t.update({order:n.combineOrderWithDirectShipping(e.shippingOption)}),e.pickupBounds&&n.getPickupOptions(e.pickupBounds).then((function(e){t.update({pickupPoints:e})})),e.pickupPoint&&t.update({order:n.combineOrderWithPickupShipping(e.pickupPoint)})}))})).catch((function(e){n.cart.showError("yapayPayment","payment not created",e)}))}},{key:"orderAccept",value:function(e){var t,n=e.shippingMethodInfo.shippingOption?"delivery":"pickup";t="pickup"===n?{address:e.shippingMethodInfo.pickupPoint.address,pickup:e.shippingMethodInfo.pickupPoint}:{address:e.shippingMethodInfo.shippingAddress,delivery:e.shippingMethodInfo.shippingOption};var r=I(I({},{setupId:this.getOption("setupId"),items:this.cart.paymentData.order.items,payment:e.paymentMethodInfo,contact:e.shippingContact,yapayAction:"orderAccept",deliveryType:n,paySystemId:this.isPaymentTypeCash(e)?this.getOption("paymentCash"):this.getOption("paySystemId"),orderAmount:e.orderAmount}),t);return this.cart.query(this.getOption("purchaseUrl"),r)}},{key:"isPaymentTypeCash",value:function(e){return"CASH"===e.paymentMethodInfo.type}},{key:"notify",value:function(e,t){var n={service:this.getOption("requestSign"),accept:"json",yandexData:t,externalId:e.externalId,paySystemId:e.paySystemId};return this.cart.query(this.getOption("notifyUrl"),n)}},{key:"changeOffer",value:function(e){var t=this;this.getOption("productId")!==e&&(this.cart.widget.setOptions({productId:e}),this.getProducts().then((function(e){t.combineOrderWithProducts(e)})))}},{key:"changeBasket",value:function(){var e=this;this.getProducts().then((function(t){e.combineOrderWithProducts(t)}))}},{key:"combineOrderWithPickupShipping",value:function(e){var t=this.cart.paymentData.order;return I(I({},t),{},{items:[].concat(babelHelpers.toConsumableArray(t.items),[{type:"SHIPPING",label:e.label,amount:e.amount}]),total:I(I({},t.total),{},{amount:this.cart.amountSum(t.total.amount,e.amount)})})}},{key:"combineOrderWithDirectShipping",value:function(e){var t=this.cart.paymentData.order;return I(I({},t),{},{items:[].concat(babelHelpers.toConsumableArray(t.items),[{type:"SHIPPING",label:e.label,amount:e.amount}]),total:I(I({},t.total),{},{amount:this.cart.amountSum(t.total.amount,e.amount)})})}},{key:"combineOrderWithProducts",value:function(e){var t=I(I({},this.cart.paymentData.order),{},{items:e.items,total:{amount:e.amount}});Object.assign(this.cart.paymentData.order,t)}},{key:"restoreButton",value:function(e){null!=this.cart.paymentButton?this.cart.paymentButton.mount(e):this.cart.insertLoader()}}]),t}(P),A=window.YaPay,j=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"render",value:function(e,t){this.isBootstrap=!1,this.element=e,this.paymentButton=null,this.proxy=this.getOption("isRest")?new E(this):new B(this),this.paymentData=this.getPaymentData(),this.bootSolution(),this.insertLoader(),this.setupPaymentCash(),this.delayBootstrap()}},{key:"compile",value:function(e){return c.compile(this.options.template,e)}},{key:"restore",value:function(e){this.element=e,this.restoreButton(e)}},{key:"bootstrap",value:function(){this.isBootstrap=!0,this.proxy.bootstrap()}},{key:"bootSolution",value:function(){var e=this.widget.getSolution();null!=e&&e.bootCart(this)}},{key:"delayChangeBasket",value:function(){this.delay("changeBasket")}},{key:"delayChangeOffer",value:function(e){this.delay("changeOffer",[e])}},{key:"delayBootstrap",value:function(){var e,t=this;e=function(){t.delay("bootstrap")},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e,1):document.addEventListener("DOMContentLoaded",e)}},{key:"changeBasket",value:function(){var e;this.isBootstrap&&(null===(e=this.proxy)||void 0===e||e.changeBasket())}},{key:"changeOffer",value:function(e){var t;this.isBootstrap&&(null===(t=this.proxy)||void 0===t||t.changeOffer(e))}},{key:"setupPaymentCash",value:function(){null!=this.getOption("paymentCash")&&this.paymentData.paymentMethods.push({type:A.PaymentMethodType.Cash})}},{key:"getPaymentData",value:function(){return this.proxy.getPaymentData()}},{key:"createPayment",value:function(e,t){this.proxy.createPayment(e,t)}},{key:"mountButton",value:function(e,t){this.paymentButton=t.createButton({type:A.ButtonType.Checkout,theme:this.getOption("buttonTheme")||A.ButtonTheme.Black,width:this.getOption("buttonWidth")||A.ButtonWidth.Auto}),this.paymentButton.mount(this.element),this.paymentButton.on(A.ButtonEventType.Click,(function(){t.checkout()}))}},{key:"restoreButton",value:function(e){this.proxy.restoreButton(e)}},{key:"amountSum",value:function(e,t){return(Number(e)+Number(t)).toFixed(2)}},{key:"showError",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=e+" - "+t;n&&(r+=" "+n),alert(r)}},{key:"insertLoader",value:function(){var e=this.getOption("buttonWidth")||A.ButtonWidth.Auto;this.element.innerHTML=c.compile(this.getOption("loaderTemplate"),{width:e.toLowerCase(),label:this.getOption("label")})}},{key:"removeLoader",value:function(){var e=this.element.querySelector(this.getOption("loaderSelector"));null!=e&&e.remove()}}]),t}(d);babelHelpers.defineProperty(j,"defaults",{loaderTemplate:'<div class="bx-yapay-skeleton-loading width--#WIDTH#"></div>',loaderSelector:".bx-yapay-skeleton-loading"});var D=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"make",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("3ds"===e)return new g(t,n);if("finished"===e)return new k(t,n);if("error"===e)return new O(t,n);if("payment"===e)return new w(t,n);if("cart"===e)return new j(t,n);throw new Error("unknown step "+e)}}]),e}(),M=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};babelHelpers.classCallCheck(this,e),this.defaults=Object.assign({},this.constructor.defaults),this.options={},this.el=t,this.setOptions(n),this.bootSolution()}return babelHelpers.createClass(e,[{key:"payment",value:function(e){this.go("payment",e)}},{key:"cart",value:function(e){this.go("cart",e)}},{key:"restore",value:function(e){var t;this.el=e,null===(t=this.step)||void 0===t||t.restore(e)}},{key:"go",value:function(e,t){this.step=this.makeStep(e),this.step.render(this.el,t)}},{key:"makeStep",value:function(e){var t=this.getOption(e)||{};return D.make(e,this,t)}},{key:"getSolution",value:function(){var e=this.getOption("solution"),n=this.getOption("mode");return t.getPage(e,n)}},{key:"bootSolution",value:function(){var e=this.getSolution();null!=e&&e.bootWidget(this)}},{key:"extendDefaults",value:function(e){this.defaults=Object.assign(this.defaults,e)}},{key:"setOptions",value:function(e){this.options=Object.assign(this.options,e)}},{key:"getOption",value:function(e){var t;return null!==(t=this.options[e])&&void 0!==t?t:this.defaults[e]}}]),e}();babelHelpers.defineProperty(M,"defaults",{}),e.Factory=y,e.Widget=M}(this.BX.YandexPay=this.BX.YandexPay||{});
//# sourceMappingURL=widget.js.map
