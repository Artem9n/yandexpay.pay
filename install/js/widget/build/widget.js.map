{"version":3,"file":"widget.js","sources":["../solutionregistry.js","../ui/nodepreserver/mutationskeleton.js","../ui/nodepreserver/mutationloop.js","../ui/nodepreserver/mutationobserver.js","../utils/eventproxy.js","../ui/nodepreserver/subscriber.js","../ui/nodepreserver.js","../ui/nodepreserver/mutationfactory.js","../utils/template.js","../factory.js","../step/abstractstep.js","../secure3d/base.js","../secure3d/form.js","../secure3d/iframe.js","../secure3d/iframerbs.js","../step/secure3d.js","../step/finish.js","../step/failure.js","../step/payment/proxy.js","../step/payment/rest.js","../step/payment/site.js","../step/payment/abstractpayment.js","../step/cart/proxy.js","../step/cart/rest.js","../step/cart/site.js","../step/cart/abstractcart.js","../utils/ready.js","../widget.js","../step/factory.js"],"sourcesContent":["export default class SolutionRegistry {\r\n\r\n\tstatic pages = {};\r\n\r\n\tstatic getFactory(name) {\r\n\t\tif (name == null) { return null; }\r\n\r\n\t\tconst factory = window?.BX?.YandexPay?.Solution?.[name]?.factory;\r\n\r\n\t\tif (factory == null) {\r\n\t\t\tconsole?.warn(`cant find solution ${name}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\treturn factory;\r\n\t}\r\n\r\n\tstatic getPage(name, mode) {\r\n\t\tif (name == null || mode == null) { return null; }\r\n\r\n\t\tconst key = name + ':' + mode;\r\n\r\n\t\tif (this.pages[key] == null) {\r\n\t\t\tthis.pages[key] = this.createPage(name, mode);\r\n\t\t}\r\n\r\n\t\treturn this.pages[key];\r\n\t}\r\n\r\n\tstatic createPage(name, mode) {\r\n\t\tconst factory = this.getFactory(name);\r\n\r\n\t\tif (factory == null) { return null; }\r\n\r\n\t\treturn factory.create(mode);\r\n\t}\r\n\r\n}","export default class MutationSkeleton {\r\n\r\n\tstatic defaults = {\r\n\t\tcheck: null,\r\n\t}\r\n\r\n\tconstructor(element, options = {}) {\r\n\t\tthis.el = element;\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\t}\r\n\r\n\tdestroy() {\r\n\r\n\t}\r\n\r\n}","import MutationSkeleton from \"./mutationskeleton\";\r\n\r\nexport default class MutationLoop extends MutationSkeleton {\r\n\r\n\tstatic defaults = Object.assign({}, MutationSkeleton.defaults, {\r\n\t\ttimeout: 1000,\r\n\t})\r\n\r\n\tconstructor(element, options = {}) {\r\n\t\tsuper(element, options);\r\n\t\tthis.loopTimeout();\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\tthis.loopCancel();\r\n\t}\r\n\r\n\tloopTimeout() {\r\n\t\tclearTimeout(this._loopTimeout);\r\n\t\tthis._loopTimeout = setTimeout(this.loop, this.options.timeout);\r\n\t}\r\n\r\n\tloopCancel() {\r\n\t\tclearTimeout(this._loopTimeout);\r\n\t}\r\n\r\n\tloop = () => {\r\n\t\tthis.options.check() && this.loopTimeout();\r\n\t}\r\n\r\n}","import MutationSkeleton from \"./mutationskeleton\";\r\n\r\nexport default class MutationObserver extends MutationSkeleton {\r\n\r\n\tstatic defaults = Object.assign({}, MutationSkeleton.defaults, {\r\n\t\tanchor: null,\r\n\t\tdelay: 0,\r\n\t})\r\n\r\n\tconstructor(element, options = {}) {\r\n\t\tsuper(element, options);\r\n\t\tthis.observe();\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\tthis.disconnect();\r\n\t}\r\n\r\n\tobserve() {\r\n\t\tconst anchor = this.getAnchor();\r\n\r\n\t\tif (anchor == null) {\r\n\t\t\tconsole?.warn('cant find anchor for node preserver');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.observer = new window.MutationObserver(this.listener);\r\n\t\tthis.observer.observe(anchor, {\r\n\t\t\tchildList: true,\r\n\t\t\tsubtree: true,\r\n\t\t});\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.observer == null) { return; }\r\n\r\n\t\tthis.observer.disconnect();\r\n\t\tthis.observer = null;\r\n\t}\r\n\r\n\tlistener = (mutations) => {\r\n\t\tfor (const mutation of mutations) {\r\n\t\t\tif (mutation.removedNodes == null) { continue; }\r\n\r\n\t\t\tfor (const removedNode of mutation.removedNodes) {\r\n\t\t\t\tif (!(removedNode instanceof HTMLElement)) { continue; }\r\n\r\n\t\t\t\tif (removedNode === this.el || removedNode.contains(this.el)) {\r\n\t\t\t\t\tthis.runCheck();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\trunCheck() {\r\n\t\tconst delay = this.options.delay;\r\n\r\n\t\tif (delay == null) {\r\n\t\t\tthis.options.check();\r\n\t\t} else {\r\n\t\t\tclearTimeout(this._checkTimeout);\r\n\t\t\tthis._checkTimeout = setTimeout(() => { this.options.check(); }, delay);\r\n\t\t}\r\n\t}\r\n\r\n\tgetAnchor() {\r\n\t\tif (this.options.anchor == null) { return document.body; }\r\n\r\n\t\treturn this.el.closest(this.options.anchor);\r\n\t}\r\n\r\n}","export class EventProxy {\r\n\r\n\tstatic make(config = {}) {\r\n\t\treturn new EventProxy(config);\r\n\t}\r\n\r\n\tconstructor(config = {}) {\r\n\t\tthis.config = config;\r\n\t\tthis.callbackMap = {};\r\n\t}\r\n\r\n\ton(name, callback) {\r\n\t\tthis.matchEvent('bx') && this.onBxEvent(name, callback);\r\n\t\tthis.matchEvent('jquery') && this.onJQueryEvent(name, callback);\r\n\t\tthis.matchEvent('plain') && this.onPlainEvent(name, callback);\r\n\t}\r\n\r\n\toff(name, callback) {\r\n\t\tthis.matchEvent('bx') && this.offBxEvent(name, callback);\r\n\t\tthis.matchEvent('jquery') && this.offJQueryEvent(name, callback);\r\n\t\tthis.matchEvent('plain') && this.offPlainEvent(name, callback);\r\n\t}\r\n\r\n\tfire(name, data = {}) {\r\n\t\tthis.matchEvent('bx') && this.fireBxEvent(name, data);\r\n\t\tthis.matchEvent('jquery') && this.fireJQueryEvent(name, data);\r\n\t\tthis.matchEvent('plain') && this.firePlainEvent(name, data);\r\n\t}\r\n\r\n\tmatchEvent(type) {\r\n\t\treturn this.config[type] != null ? !!this.config[type] : !this.config['strict'];\r\n\t}\r\n\r\n\tonBxEvent(name, callback) {\r\n\t\tif (typeof BX === 'undefined') { return; }\r\n\r\n\t\tBX.addCustomEvent(name, callback);\r\n\t}\r\n\r\n\toffBxEvent(name, callback) {\r\n\t\tif (typeof BX === 'undefined') { return; }\r\n\r\n\t\tBX.removeCustomEvent(name, callback);\r\n\t}\r\n\r\n\tfireBxEvent(name, data) {\r\n\t\tif (typeof BX === 'undefined') { return; }\r\n\r\n\t\tBX.onCustomEvent(name, [data]);\r\n\t}\r\n\r\n\tonJQueryEvent(name, callback) {\r\n\t\tif (typeof jQuery === 'undefined') { return; }\r\n\r\n\t\tconst selfConfig = this.typeConfig('jquery');\r\n\r\n\t\tif (this.canProxyCallback(selfConfig)) {\r\n\t\t\tconst originalCallback = callback;\r\n\r\n\t\t\tcallback = (evt, data) => {\r\n\t\t\t\tconst proxyData = data != null ? data : evt?.originalEvent?.detail;\r\n\r\n\t\t\t\toriginalCallback(proxyData);\r\n\t\t\t};\r\n\r\n\t\t\tthis.pushCallbackVariation('jquery', originalCallback, callback);\r\n\t\t}\r\n\r\n\t\tjQuery(document).on(name, callback);\r\n\t}\r\n\r\n\toffJQueryEvent(name, callback) {\r\n\t\tif (typeof jQuery === 'undefined') { return; }\r\n\r\n\t\tconst selfConfig = this.typeConfig('jquery');\r\n\r\n\t\tif (this.canProxyCallback(selfConfig)) {\r\n\t\t\tcallback = this.popCallbackVariation('jquery', callback);\r\n\r\n\t\t\tif (callback == null) { return; }\r\n\t\t}\r\n\r\n\t\tjQuery(document).off(name, callback);\r\n\t}\r\n\r\n\tfireJQueryEvent(name, data) {\r\n\t\tif (typeof jQuery === 'undefined') { return; }\r\n\t\tif (this.hasPlainAndJQueryCollision()) { return; }\r\n\r\n\t\tjQuery(document).triggerHandler(new CustomEvent(name, { \"detail\": data }));\r\n\t}\r\n\r\n\tonPlainEvent(name, callback) {\r\n\t\tif (this.hasPlainAndJQueryCollision()) { return; }\r\n\r\n\t\tconst selfConfig = this.typeConfig('plain');\r\n\r\n\t\tif (this.canProxyCallback(selfConfig)) {\r\n\t\t\tconst originalCallback = callback;\r\n\r\n\t\t\tcallback = (evt) => {\r\n\t\t\t\toriginalCallback(evt.detail);\r\n\t\t\t};\r\n\r\n\t\t\tthis.pushCallbackVariation('plain', originalCallback, callback);\r\n\t\t}\r\n\r\n\t\tdocument.addEventListener(name, callback);\r\n\t}\r\n\r\n\toffPlainEvent(name, callback) {\r\n\t\tif (this.hasPlainAndJQueryCollision()) { return; }\r\n\r\n\t\tconst selfConfig = this.typeConfig('plain');\r\n\r\n\t\tif (this.canProxyCallback(selfConfig)) {\r\n\t\t\tcallback = this.popCallbackVariation('plain', callback);\r\n\r\n\t\t\tif (callback == null) { return; }\r\n\t\t}\r\n\r\n\t\tdocument.removeEventListener(name, callback);\r\n\t}\r\n\r\n\tfirePlainEvent(name, data) {\r\n\t\tdocument.dispatchEvent(new CustomEvent(name, { \"detail\": data }));\r\n\t}\r\n\r\n\thasPlainAndJQueryCollision() {\r\n\t\tif (!this.matchEvent('plain') || !this.matchEvent('jquery')) { return false; }\r\n\r\n\t\tconst plainConfig = this.typeConfig('plain');\r\n\r\n\t\treturn (plainConfig['force'] !== true && typeof jQuery !== 'undefined');\r\n\t}\r\n\r\n\tcanProxyCallback(selfConfig) {\r\n\t\treturn selfConfig['proxy'] !== false;\r\n\t}\r\n\r\n\ttypeConfig(type) {\r\n\t\treturn typeof this.config[type] === 'object' && this.config[type] != null ? this.config : {};\r\n\t}\r\n\r\n\tpushCallbackVariation(type, callback, proxy) {\r\n\t\tif (this.callbackMap[type] == null) {\r\n\t\t\tthis.callbackMap[type] = new WeakMap();\r\n\t\t}\r\n\r\n\t\tthis.callbackMap[type].set(callback, proxy);\r\n\t}\r\n\r\n\tpopCallbackVariation(type, callback) {\r\n\t\tif (this.callbackMap[type] == null) { return null; }\r\n\r\n\t\tconst map = this.callbackMap[type];\r\n\t\tconst result = map.get(callback);\r\n\r\n\t\tif (result != null) {\r\n\t\t\tmap.delete(callback);\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n}","import {EventProxy} from \"../../utils/eventproxy\";\r\n\r\nexport default class Subscriber {\r\n\r\n\tstatic defaults = {\r\n\t\tcheck: null,\r\n\t\tevent: null,\r\n\t\tconfig: {},\r\n\t\ton: null,\r\n\t\toff: null,\r\n\t}\r\n\r\n\tconstructor(element, options = {}) {\r\n\t\tthis.el = element;\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\t\tthis.eventProxy = new EventProxy(this.options.config);\r\n\r\n\t\tthis.bind();\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\tthis.unbind();\r\n\r\n\t\tthis.eventProxy = null;\r\n\t\tthis.options = {};\r\n\t\tthis.el = null;\r\n\t}\r\n\r\n\tbind() {\r\n\t\tthis.bindOn();\r\n\t\tthis.bindEvent();\r\n\t}\r\n\r\n\tunbind() {\r\n\t\tthis.unbindOff();\r\n\t\tthis.unbindEvent();\r\n\t}\r\n\r\n\tbindOn() {\r\n\t\tif (this.options.on == null) { return; }\r\n\r\n\t\tthis.options.on(this.options.check);\r\n\t}\r\n\r\n\tunbindOff() {\r\n\t\tif (this.options.off == null) { return; }\r\n\r\n\t\tthis.options.off(this.options.check);\r\n\t}\r\n\r\n\tbindEvent() {\r\n\t\tconst event = this.options.event;\r\n\r\n\t\tif (event == null) { return; }\r\n\r\n\t\tif (typeof event === 'string') {\r\n\t\t\tthis.eventProxy.on(event, this.options.check);\r\n\t\t} else if (Array.isArray(event)) {\r\n\t\t\tevent.forEach((one) => {\r\n\t\t\t\tthis.eventProxy.on(one, this.options.check);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tconsole?.warn(`unknown event type ${typeof event}`);\r\n\t\t}\r\n\t}\r\n\r\n\tunbindEvent() {\r\n\t\tconst event = this.options.event;\r\n\r\n\t\tif (event == null) { return; }\r\n\r\n\t\tif (typeof event === 'string') {\r\n\t\t\tthis.eventProxy.off(event, this.options.check);\r\n\t\t} else if (Array.isArray(event)) {\r\n\t\t\tevent.forEach((one) => {\r\n\t\t\t\tthis.eventProxy.off(one, this.options.check);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tconsole?.warn(`unknown event type ${typeof event}`);\r\n\t\t}\r\n\t}\r\n\r\n}","import MutationFactory from \"./nodepreserver/mutationfactory\";\r\nimport Subscriber from \"./nodepreserver/subscriber\";\r\n\r\nexport default class NodePreserver {\r\n\r\n\tstatic defaults = {\r\n\t\trestore: null,\r\n\t\tsubscriber: null,\r\n\t\tmutation: true,\r\n\t}\r\n\r\n\t/** @var MutationSkeleton */\r\n\tmutation;\r\n\t/** @var Subscriber */\r\n\tsubscriber;\r\n\r\n\tconstructor(element, options = {}) {\r\n\t\tthis.el = element;\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\r\n\t\tthis.install();\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\tthis.uninstall();\r\n\t\tthis.options = {};\r\n\t\tthis.el = null;\r\n\t}\r\n\r\n\tinstall() {\r\n\t\tthis.installMutation();\r\n\t\tthis.installSubscriber();\r\n\t}\r\n\r\n\tuninstall() {\r\n\t\tthis.uninstallMutation();\r\n\t\tthis.uninstallSubscriber();\r\n\t}\r\n\r\n\tinstallMutation() {\r\n\t\tif (!this.isEnabled('mutation')) { return; }\r\n\r\n\t\tthis.mutation = MutationFactory.make(this.el, this.driverOptions('mutation'));\r\n\t}\r\n\r\n\tuninstallMutation() {\r\n\t\tif (this.mutation == null) { return; }\r\n\r\n\t\tthis.mutation.destroy();\r\n\t}\r\n\r\n\tinstallSubscriber() {\r\n\t\tif (!this.isEnabled('subscriber')) { return; }\r\n\r\n\t\tthis.subscriber = new Subscriber(this.el, this.driverOptions('subscriber'));\r\n\t}\r\n\r\n\tuninstallSubscriber() {\r\n\t\tif (this.subscriber == null) { return; }\r\n\r\n\t\tthis.subscriber.destroy();\r\n\t\tthis.subscriber = null;\r\n\t}\r\n\r\n\tisEnabled(type) {\r\n\t\treturn !!this.options[type];\r\n\t}\r\n\r\n\tdriverOptions(type) {\r\n\t\tconst option = typeof this.options[type] === 'object' ? this.options[type] : {};\r\n\t\tconst overrides = {\r\n\t\t\tcheck: this.check,\r\n\t\t};\r\n\r\n\t\treturn Object.assign({}, option, overrides);\r\n\t}\r\n\r\n\tcheck = () => {\r\n\t\tconst found = document.body.contains(this.el);\r\n\r\n\t\tif (!found) {\r\n\t\t\tthis.options.restore();\r\n\t\t}\r\n\r\n\t\treturn found;\r\n\t}\r\n}","import MutationLoop from \"./mutationloop\";\r\nimport MutationObserver from \"./mutationobserver\";\r\n\r\nexport default class MutationFactory {\r\n\r\n\tstatic make(element, options) {\r\n\t\tif (typeof window.MutationObserver === 'function') {\r\n\t\t\treturn new MutationObserver(element, options);\r\n\t\t}\r\n\r\n\t\treturn new MutationLoop(element, options);\r\n\t}\r\n\r\n}","export default class Template {\r\n\r\n\t/**\r\n\t * @param {string=} template\r\n\t * @param {Object} vars\r\n\t * @returns {string}\r\n\t */\r\n\tstatic compile(template, vars) {\r\n\t\tlet key;\r\n\t\tlet replaceKey;\r\n\t\tlet replaceValue;\r\n\t\tlet result = template;\r\n\r\n\t\tfor (key in vars) {\r\n\t\t\tif (!vars.hasOwnProperty(key)) { continue; }\r\n\r\n\t\t\treplaceKey = '#' + key.toUpperCase() + '#';\r\n\t\t\treplaceValue = vars[key];\r\n\r\n\t\t\tdo {\r\n\t\t\t\tresult = result.replace(replaceKey, replaceValue);\r\n\t\t\t} while (result.indexOf(replaceKey) !== -1);\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tstatic toElement(html) {\r\n\t\tconst context = document.createElement('div');\r\n\t\tcontext.innerHTML = html;\r\n\r\n\t\treturn context.firstElementChild;\r\n\t}\r\n\r\n\tstatic toElements(html) {\r\n\t\tconst context = document.createElement('div');\r\n\t\tcontext.innerHTML = html;\r\n\r\n\t\treturn [...context.children];\r\n\t}\r\n\r\n}","import SolutionRegistry from './solutionregistry';\r\nimport NodePreserver from \"./ui/nodepreserver\";\r\nimport Utils from './utils/template';\r\nimport {EventProxy} from \"./utils/eventproxy\";\r\n\r\nexport default class Factory {\r\n\r\n\tstatic defaults = {\r\n\t\tsolution: null,\r\n\t\ttemplate: '<div id=\"yandexpay\" class=\"bx-yapay-drawer\"></div>',\r\n\t\tcontainerSelector: '.bx-yapay-drawer',\r\n\t\tpreserve: false,\r\n\t\twaitLimit: 30,\r\n\t\twaitTimeout: 1000,\r\n\t}\r\n\r\n\tdefaults;\r\n\toptions;\r\n\twaitCount = 0;\r\n\r\n\tconstructor(options = {}) {\r\n\t\tthis.defaults = Object.assign({}, this.constructor.defaults);\r\n\t\tthis.options = {};\r\n\r\n\t\tthis.setOptions(options);\r\n\t\tthis.bootSolution();\r\n\t\tthis.bootLocal();\r\n\t}\r\n\r\n\tinject(selector, position) {\r\n\t\treturn Promise.resolve()\r\n\t\t\t.then(() => this.waitElement(selector))\r\n\t\t\t.then((anchor) => this.checkElement(anchor))\r\n\t\t\t.then((anchor) => {\r\n\t\t\t\tconst element = this.renderElement(anchor, position);\r\n\t\t\t\tconst widget = this.install(element);\r\n\r\n\t\t\t\tif (this.getOption('preserve')) {\r\n\t\t\t\t\tthis.preserve(selector, position, widget);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn widget;\r\n\t\t\t})\r\n\t}\r\n\r\n\tcheckElement(anchor) {\r\n\t\tconst selector = this.getOption('containerSelector');\r\n\t\tconst contains = (\r\n\t\t\t!!anchor.querySelector(selector)\r\n\t\t\t|| this.containsSiblingElement(anchor, selector)\r\n\t\t);\r\n\r\n\t\tif (contains) {\r\n\t\t\tthrow new Error('the element already has a container');\r\n\t\t}\r\n\r\n\t\treturn anchor;\r\n\t}\r\n\r\n\tcontainsSiblingElement(anchor, selector) {\r\n\t\tlet result = false;\r\n\t\tlet next = anchor.parentElement?.firstElementChild;\r\n\r\n\t\twhile (next) {\r\n\t\t\tif (next.matches(selector) || next.querySelector(selector)) {\r\n\t\t\t\tresult = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tnext = next.nextElementSibling;\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpreserve(selector, position, widget) {\r\n\t\tconst preserver = new NodePreserver(widget.el, Object.assign({}, this.preserveOptions(), {\r\n\t\t\trestore: () => {\r\n\t\t\t\tpreserver.destroy();\r\n\t\t\t\t// noinspection JSIgnoredPromiseFromCall\r\n\t\t\t\tthis.restore(selector, position, widget);\r\n\t\t\t},\r\n\t\t}));\r\n\t}\r\n\r\n\tpreserveOptions() {\r\n\t\tconst preserveOption = this.getOption('preserve');\r\n\r\n\t\treturn typeof preserveOption === 'object' ? preserveOption : {};\r\n\t}\r\n\r\n\trestore(selector, position, widget) {\r\n\t\treturn Promise.resolve()\r\n\t\t\t.then(() => this.waitElement(selector))\r\n\t\t\t.then((anchor) => {\r\n\t\t\t\tconst element = this.renderElement(anchor, position);\r\n\r\n\t\t\t\twidget.restore(element);\r\n\r\n\t\t\t\tif (this.getOption('preserve')) {\r\n\t\t\t\t\tthis.preserve(selector, position, widget);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn widget;\r\n\t\t\t});\r\n\t}\r\n\r\n\tinstall(element) {\r\n\t\treturn new BX.YandexPay.Widget(element);\r\n\t}\r\n\r\n\twaitElement(selector) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.waitCount = 0;\r\n\t\t\tthis.waitElementLoop(selector, resolve, reject);\r\n\t\t});\r\n\t}\r\n\r\n\twaitElementLoop(selector, resolve, reject) {\r\n\t\tconst anchor = this.findElement(selector);\r\n\r\n\t\tif (anchor) {\r\n\t\t\tresolve(anchor);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t++this.waitCount;\r\n\r\n\t\tif (this.waitCount >= this.getOption('waitLimit')) {\r\n\t\t\treject('cant find element by selector ' + selector);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsetTimeout(this.waitElementLoop.bind(this, selector, resolve, reject), this.getOption('waitTimeout'));\r\n\t}\r\n\r\n\tfindElement(selector) {\r\n\t\tlet elementList;\r\n\t\tlet variant = selector.trim();\r\n\t\tlet result;\r\n\r\n\t\tif (variant === '') { throw new Error('widget selector is empty'); }\r\n\r\n\t\telementList = this.searchBySelector(variant) ?? this.searchById(selector) ?? this.searchByClassName(selector);\r\n\r\n\t\tif (elementList == null) { return null; }\r\n\r\n\t\tif (elementList.length > 1) {\r\n\t\t\tresult = this.reduceVisible(elementList);\r\n\t\t}\r\n\r\n\t\tif (result == null) {\r\n\t\t\tresult = elementList[0];\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tsearchBySelector(selector) {\r\n\t\ttry {\r\n\t\t\tconst result = [];\r\n\r\n\t\t\tfor (const part of selector.split(',')) { // first selector\r\n\t\t\t\tconst partSanitized = part.trim();\r\n\r\n\t\t\t\tif (partSanitized === '' || !this.isCssSelector(partSanitized)) { continue; }\r\n\r\n\t\t\t\tconst collection = document.querySelectorAll(partSanitized);\r\n\r\n\t\t\t\tfor (const element of collection) {\r\n\t\t\t\t\tresult.push(element);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn result.length > 0 ? result : null;\r\n\t\t} catch (e) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tsearchById(selector) {\r\n\t\ttry {\r\n\t\t\tconst element = document.getElementById(selector);\r\n\r\n\t\t\treturn element != null ? [element] : null;\r\n\t\t} catch (e) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tsearchByClassName(selector) {\r\n\t\ttry {\r\n\t\t\tconst collection = document.getElementsByClassName(selector);\r\n\r\n\t\t\treturn collection.length > 0 ? collection : null;\r\n\t\t} catch (e) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\treduceVisible(collection) {\r\n\t\tlet result = null;\r\n\t\t\r\n\t\tfor (const element of collection) {\r\n\t\t\tif (this.testVisible(element)) {\r\n\t\t\t\tresult = element;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\ttestVisible(element) {\r\n\t\treturn (element.offsetWidth || element.offsetHeight || element.getClientRects().length );\r\n\t}\r\n\r\n\tisCssSelector(selector) {\r\n\t\treturn /^[.#]/.test(selector);\r\n\t}\r\n\r\n\trenderElement(anchor, position) {\r\n\t\tconst selector = this.getOption('containerSelector');\r\n\t\tconst width = this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto;\r\n\t\tconst html = Utils.compile(this.getOption('template'), {\r\n\t\t\tlabel: this.getOption('label'),\r\n\t\t\twidth: width.toLowerCase(),\r\n\t\t});\r\n\t\tlet elements = Utils.toElements(html);\r\n\t\tlet result = null;\r\n\r\n\t\tif (position.indexOf('after') === 0) { elements = elements.reverse(); }\r\n\r\n\t\tfor (const element of elements) {\r\n\t\t\tanchor.insertAdjacentElement(position, element);\r\n\r\n\t\t\tif (result != null) { continue; }\r\n\r\n\t\t\tresult = element.matches(selector) ? element : element.querySelector(selector);\r\n\t\t}\r\n\r\n\t\tif (result == null) {\r\n\t\t\tthrow new Error(`cant find template container by selector ${selector}`);\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tbootSolution() {\r\n\t\tconst name = this.getOption('solution');\r\n\t\tconst mode = this.getOption('mode');\r\n\t\tconst solution = SolutionRegistry.getPage(name, mode);\r\n\r\n\t\tif (solution == null) { return; }\r\n\r\n\t\tsolution.bootFactory(this);\r\n\t}\r\n\r\n\tbootLocal() {\r\n\t\tEventProxy.make().fire('bxYapayFactoryInit', {\r\n\t\t\tfactory: this,\r\n\t\t});\r\n\t}\r\n\r\n\textendDefaults(options) {\r\n\t\tthis.defaults = Object.assign(this.defaults, options);\r\n\t}\r\n\r\n\tsetOptions(options) {\r\n\t\tthis.options = Object.assign(this.options, options);\r\n\t}\r\n\r\n\tgetOption(name) {\r\n\t\treturn this.options[name] ?? this.defaults[name]\r\n\t}\r\n}","import Template from '../utils/template';\r\n\r\nexport default class AbstractStep {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '',\r\n\t}\r\n\r\n\tdefaults;\r\n\toptions;\r\n\twidget;\r\n\tdelayTimeouts = {};\r\n\r\n\t/**\r\n\t * @param {Widget} widget\r\n\t * @param {Object} options\r\n\t */\r\n\tconstructor(widget, options = {}) {\r\n\t\tthis.widget = widget;\r\n\t\tthis.defaults = Object.assign({}, this.constructor.defaults);\r\n\t\tthis.options = Object.assign({}, options);\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * @param {string} name\r\n\t * @returns {*}\r\n\t */\r\n\tgetOption(name) {\r\n\t\treturn this.options[name] ?? this.widget.getOption(name) ?? this.defaults[name];\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Object<Element>} node Element\r\n\t * @param {Object} data Options\r\n\t */\r\n\trender(node, data = {}) {\r\n\t\tnode.innerHTML = this.compile(data);\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Object} data\r\n\t * @returns {string}\r\n\t */\r\n\tcompile(data) {\r\n\t\treturn Template.compile(this.getOption('template'), data);\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Object<Element>} node\r\n\t */\r\n\trestore(node) {\r\n\t\t// nothing by default\r\n\t}\r\n\r\n\t/**\r\n\t * @param {string} url\r\n\t * @param {Object} data\r\n\t * @returns {Promise.<Object>}\r\n\t */\r\n\tquery(url, data) {\r\n\t\treturn fetch(url, {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: { 'Content-Type': 'application/json' },\r\n\t\t\tbody: JSON.stringify(data)\r\n\t\t})\r\n\t\t\t.then(response => {return response.json()})\r\n\t}\r\n\r\n\tgetTemplate(key) {\r\n\t\tlet optionKey = key + 'Template';\r\n\t\tlet option = this.options[optionKey];\r\n\t\tlet optionFirstSymbol = option.substr(0, 1);\r\n\t\tlet result;\r\n\r\n\t\tif (optionFirstSymbol === '.' || optionFirstSymbol === '#') {\r\n\t\t\tresult = this.getNode(option).innerHTML;\r\n\t\t} else {\r\n\t\t\tresult = option;\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tgetElement(key, context, method) {\r\n\t\tlet selector = this.getElementSelector(key);\r\n\r\n\t\treturn this.getNode(selector, context, method || 'querySelector');\r\n\t}\r\n\r\n\tgetElementSelector(key) {\r\n\t\tlet optionKey = key + 'Element';\r\n\r\n\t\treturn this.options[optionKey];\r\n\t}\r\n\r\n\tgetNode(selector, context, method) {\r\n\t\tif (selector.substr(0, 1) === '#') { // is id query\r\n\t\t\tcontext = document;\r\n\t\t} else if (!context) {\r\n\t\t\tcontext = this.el;\r\n\t\t}\r\n\r\n\t\treturn context[method](selector);\r\n\t}\r\n\r\n\tclearDelay(name) {\r\n\t\tif (this.delayTimeouts[name] == null) { return; }\r\n\r\n\t\tclearTimeout(this.delayTimeouts[name]);\r\n\t\tthis.delayTimeouts[name] = null;\r\n\t}\r\n\r\n\tdelay(name, args = [], timeout = 300) {\r\n\t\tthis.clearDelay(name);\r\n\t\tthis.delayTimeouts[name] = setTimeout(this[name].bind(this, ...args), timeout);\r\n\t}\r\n\r\n\tshowError(type, message, err = null) {\r\n\t\tlet notify = type + ' - ' + message;\r\n\r\n\t\tif (err) {\r\n\t\t\tnotify += ' ' + err;\r\n\t\t}\r\n\r\n\t\talert(notify);\r\n\t}\r\n}","import Template from \"../utils/template\";\r\n\r\nexport default class Base {\r\n\tstatic defaults = {\r\n\t\ttemplate: null,\r\n\t}\r\n\r\n\tconstructor(options = {}) {\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\t\tthis.widget = null;\r\n\t}\r\n\r\n\trender(node, data = {}) {\r\n\t\tnode.innerHTML = this.compile(data);\r\n\t}\r\n\r\n\tcompile(data) {\r\n\t\treturn Template.compile(this.options.template, data);\r\n\t}\r\n\r\n\tsetWidget(widget) {\r\n\t\tthis.widget = widget;\r\n\t}\r\n\r\n\tgetOption(key) {\r\n\t\tif (key in this.options) {\r\n\t\t\treturn this.options[key];\r\n\t\t} else {\r\n\t\t\treturn this.widget.options[key];\r\n\t\t}\r\n\t}\r\n}","import Base from \"./base\";\r\nimport Template from \"../utils/template\";\r\n\r\nexport default class Form extends Base {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<form name=\"form\" action=\"#ACTION#\" method=\"#METHOD#\">'\r\n\t\t\t+ '#INPUTS#'\r\n\t\t\t+ '</form>',\r\n\t}\r\n\r\n\trender(node, data) {\r\n\t\tsuper.render(node, data);\r\n\t\tthis.autosubmit(node);\r\n\t}\r\n\r\n\tcompile(data) {\r\n\t\tconst template = this.options.template;\r\n\t\tconst vars = Object.assign(data, {\r\n\t\t\t'inputs': this.makeInputs(data)\r\n\t\t});\r\n\r\n\t\treturn Template.compile(template, vars);\r\n\t}\r\n\r\n\tmakeInputs(data) {\r\n\t\tlet key;\r\n\t\tlet vars = data.params;\r\n\t\tlet value;\r\n\t\tlet template;\r\n\r\n\t\tif (Object.keys(vars).length === 0) { return ''; }\r\n\r\n\t\ttemplate = data.termUrl ? '<input type=\"hidden\" name=\"TermUrl\" value=\"' + vars.termUrl + '\">' : '';\r\n\r\n\t\tfor (key in vars)\r\n\t\t{\r\n\t\t\tif (!vars.hasOwnProperty(key)) { continue; }\r\n\r\n\t\t\tvalue = vars[key];\r\n\r\n\t\t\ttemplate += '<input type=\"hidden\" name=\"' + key + '\" value=\"' + value + '\">';\r\n\t\t}\r\n\r\n\t\treturn template;\r\n\t}\r\n\r\n\tmakeTermUrl() {\r\n\t\tlet result = this.getOption('notifyUrl');\r\n\t\tlet backUrl = window.location.href;\r\n\r\n\t\tresult +=\r\n\t\t\t(result.indexOf('?') === -1 ? '?' : '&')\r\n\t\t\t+ 'backurl=' + encodeURIComponent(backUrl)\r\n\t\t\t+ '&service=' + this.getOption('requestSign')\r\n\t\t\t+ '&paymentId=' + this.getOption('externalId');\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tautosubmit(node) {\r\n\t\tconst form = node.querySelector('form');\r\n\r\n\t\tform.submit();\r\n\t}\r\n}","import Base from \"./base\";\r\nimport Template from \"../utils/template\";\r\n\r\nexport default class Iframe extends Base {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<iframe style=\"display: none;\"></iframe>',\r\n\t}\r\n\r\n\trender(node, data) {\r\n\t\tthis.insertIframe(node, data);\r\n\t}\r\n\r\n\tinsertIframe(node, data) {\r\n\t\tnode.innerHTML = Template.compile(this.options.template, data);\r\n\t\tthis.compile(node, data);\r\n\t}\r\n\r\n\tcompile(node, data) {\r\n\t\tlet iframe = node.querySelector('iframe');\r\n\t\tlet contentIframe = iframe.contentWindow || ( iframe.contentDocument.document || iframe.contentDocument);\r\n\t\tlet html = data.params;\r\n\r\n\t\tcontentIframe.document.open();\r\n\t\tcontentIframe.document.write(html);\r\n\t\tcontentIframe.document.close();\r\n\t}\r\n}","import Base from \"./base\";\r\nimport Template from \"../utils/template\";\r\n\r\nexport default class IframeRbs extends Base {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<iframe style=\"display: none;\"></iframe>',\r\n\t}\r\n\r\n\trender(node, data) {\r\n\t\tthis.insertIframe(node, data);\r\n\t}\r\n\r\n\tinsertIframe(node, data) {\r\n\t\tnode.innerHTML = Template.compile(this.options.template, data);\r\n\t\tthis.compile(node, data);\r\n\t}\r\n\r\n\tcompile(node, data) {\r\n\t\tPromise.resolve()\r\n\t\t\t.then(() => this.renderIframe(node, data))\r\n\t\t\t.then(() => this.query(data));\r\n\t}\r\n\r\n\tquery (data) {\r\n\t\tfetch(this.getOption('notifyUrl'), {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: JSON.stringify({\r\n\t\t\t\tservice: this.getOption('requestSign'),\r\n\t\t\t\taccept: 'json',\r\n\t\t\t\tsecure: data.params.secure,\r\n\t\t\t\texternalId: data.params.notify.externalId,\r\n\t\t\t\tpaySystemId: data.params.notify.paySystemId\r\n\t\t\t})\r\n\t\t})\r\n\t\t\t.then(response => response.json())\r\n\t\t\t.then(result => {\r\n\t\t\t\tif (result.success === true) {\r\n\t\t\t\t\tthis.widget.go(result.state, result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.widget.go('error', result);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.catch(error => console.log(error) );\r\n\t}\r\n\r\n\trenderIframe(node, data) {\r\n\t\tlet iframe = node.querySelector('iframe');\r\n\t\tlet contentIframe = iframe.contentWindow || ( iframe.contentDocument.document || iframe.contentDocument);\r\n\t\tlet html = `<form name=\"form\" action=\"${data.action}\" method=\"POST\">`;\r\n\r\n\t\tcontentIframe.document.open();\r\n\t\tcontentIframe.document.write(html);\r\n\t\tcontentIframe.document.close();\r\n\r\n\t\tcontentIframe.document.querySelector('form').submit();\r\n\t}\r\n}\r\n","import AbstractStep from \"./abstractstep\";\r\nimport SecureForm from \"../secure3d/form\";\r\nimport SecureIframe from \"../secure3d/iframe\";\r\nimport SecureRbs from \"../secure3d/iframerbs\";\r\n\r\nexport default class Step3ds extends AbstractStep {\r\n\r\n\trender(node, data) {\r\n\t\tconst view = this.makeView(data);\r\n\t\tview.setWidget(this.widget);\r\n\t\tview.render(node, data);\r\n\t}\r\n\r\n\tmakeView(data) {\r\n\t\tlet view = data.view;\r\n\r\n\t\tif (view === 'form') {\r\n\t\t\treturn new SecureForm();\r\n\t\t} else if (view === 'iframe') {\r\n\t\t\treturn new SecureIframe();\r\n\t\t} else if (view === 'iframerbs') {\r\n\t\t\treturn new SecureRbs();\r\n\t\t}\r\n\r\n\t\tthrow new Error('view secure3d missing')\r\n\t}\r\n}","import AbstractStep from './abstractstep';\r\n\r\nexport default class Finish extends AbstractStep {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<div class=\"alert alert-success\" role=\"alert\"><strong>#MESSAGE#</strong></div>'\r\n\t}\r\n\r\n}","import AbstractStep from './abstractstep';\r\n\r\nexport default class Failure extends AbstractStep {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<div class=\"alert alert-danger\" role=\"alert\"><strong>#MESSAGE#</strong></div>'\r\n\t}\r\n\r\n}","export default class Proxy {\r\n\r\n\tconstructor(order) {\r\n\t\tthis.order = order;\r\n\t}\r\n\r\n\tgetOption(name) {\r\n\t\treturn this.order.getOption(name);\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\r\n\t}\r\n\r\n\tgetPaymentData(data) {\r\n\r\n\t}\r\n}","import Proxy from \"./proxy\";\r\n\r\nexport default class RestProxy extends Proxy {\r\n\r\n\tgetPaymentData(data) {\r\n\t\treturn   {\r\n\t\t\tenv: this.getOption('env'),\r\n\t\t\tversion: 3,\r\n\t\t\tcurrencyCode: YaPay.CurrencyCode.Rub,\r\n\t\t\tmerchantId: this.getOption('merchantId'),\r\n\t\t\torderId: data.id,\r\n\t\t\tcart: {\r\n\t\t\t\titems: data.items,\r\n\t\t\t\ttotal: {\r\n\t\t\t\t\tamount: data.total,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tmetadata: this.getOption('metadata'),\r\n\t\t}\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\t// Создать платеж.\r\n\t\tYaPay.createPayment(paymentData, { agent: { name: \"CMS-Bitrix\", version: \"1.0\" } })\r\n\t\t\t.then((payment) => {\r\n\r\n\t\t\t\t// Смонтировать кнопку в DOM.\r\n\t\t\t\tpayment.mountButton(node, {\r\n\t\t\t\t\ttype: YaPay.ButtonType.Pay,\r\n\t\t\t\t\ttheme: this.getOption('buttonTheme') || YaPay.ButtonTheme.Black,\r\n\t\t\t\t\twidth: this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto,\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Подписаться на событие process.\r\n\t\t\t\tpayment.on(YaPay.CheckoutEventType.Success, (event) => {\r\n\r\n\t\t\t\t\tnode.remove();\r\n\r\n\t\t\t\t\tthis.authorize(event)\r\n\t\t\t\t\t\t.then((result) => {\r\n\t\t\t\t\t\t\tif (result.status === 'success') {\r\n\t\t\t\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\t\t\t\twindow.location.href = result.data.redirect;\r\n\t\t\t\t\t\t\t\t}, 1000);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tthis.order.showError('authorize', result.reasonCode, result.reason);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Success);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.CheckoutEventType.Abort, (event) => {\r\n\t\t\t\t\t// ...\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.CheckoutEventType.Error, (event) => {\r\n\t\t\t\t\tthis.order.showError('yapayPayment', 'error', event);\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.catch((err) => {\r\n\t\t\t\tthis.order.showError('yapayPayment','payment not created', err);\r\n\t\t\t});\r\n\t}\r\n\r\n\tauthorize(event) {\r\n\t\tlet data = {\r\n\t\t\torderId: event.orderId,\r\n\t\t\thash: event.metadata,\r\n\t\t\tsuccessUrl: this.getOption('successUrl'),\r\n\t\t};\r\n\r\n\t\treturn this.order.query(this.getOption('restUrl') + 'authorize', data);\r\n\t}\r\n}","import Proxy from \"./proxy\";\r\n\r\nexport default class SiteProxy extends Proxy {\r\n\r\n\tgetPaymentData(data) {\r\n\t\treturn {\r\n\t\t\tenv: this.getOption('env'),\r\n\t\t\tversion: 2,\r\n\t\t\tcountryCode: YaPay.CountryCode.Ru,\r\n\t\t\tcurrencyCode: YaPay.CurrencyCode.Rub,\r\n\t\t\tmerchant: {\r\n\t\t\t\tid: this.getOption('merchantId'),\r\n\t\t\t\tname: this.getOption('merchantName')\r\n\t\t\t},\r\n\t\t\torder: {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\ttotal: { amount: data.total },\r\n\t\t\t\titems: data.items\r\n\t\t\t},\r\n\t\t\tpaymentMethods: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: YaPay.PaymentMethodType.Card,\r\n\t\t\t\t\tgateway: this.getOption('gateway'),\r\n\t\t\t\t\tgatewayMerchantId: this.getOption('gatewayMerchantId'),\r\n\t\t\t\t\tallowedAuthMethods: [YaPay.AllowedAuthMethod.PanOnly],\r\n\t\t\t\t\tallowedCardNetworks: [\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.UnionPay,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Uzcard,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Discover,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.AmericanExpress,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Visa,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Mastercard,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Mir,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Maestro,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.VisaElectron\r\n\t\t\t\t\t]\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t}\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\tYaPay.createPayment(paymentData, { agent: { name: \"CMS-Bitrix\", version: \"1.0\" } })\r\n\t\t\t.then( (payment) => {\r\n\t\t\t\tlet button = payment.createButton({\r\n\t\t\t\t\ttype: YaPay.ButtonType.Pay,\r\n\t\t\t\t\ttheme: this.getOption('buttonTheme') || YaPay.ButtonTheme.Black,\r\n\t\t\t\t\twidth: this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tbutton.mount(node);\r\n\r\n\t\t\t\tbutton.on(YaPay.ButtonEventType.Click, function onPaymentButtonClick() {\r\n\t\t\t\t\tpayment.checkout();\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Process, (event) => {\r\n\r\n\t\t\t\t\tthis.notify(payment, event).then((result) => {});\r\n\r\n\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Success);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Error, function onPaymentError(event) {\r\n\t\t\t\t\tconsole.log({'errors': event});\r\n\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Error);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Abort, function onPaymentAbort(event) {});\r\n\t\t\t})\r\n\t\t\t.catch(function (err) {\r\n\t\t\t\tconsole.log({'payment not create': err});\r\n\t\t\t});\r\n\t}\r\n\r\n\tnotify(payment, yandexPayData) {\r\n\t\treturn fetch(this.getOption('notifyUrl'), {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: JSON.stringify({\r\n\t\t\t\tservice: this.getOption('requestSign'),\r\n\t\t\t\taccept: 'json',\r\n\t\t\t\tyandexData: yandexPayData,\r\n\t\t\t\texternalId: this.getOption('externalId'),\r\n\t\t\t\tpaySystemId: this.getOption('paySystemId')\r\n\t\t\t})\r\n\t\t})\r\n\t\t\t.then(response => response.json())\r\n\t\t\t.then(result => {\r\n\t\t\t\tif (result.success === true) {\r\n\t\t\t\t\tthis.order.widget.go(result.state, result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.order.widget.go('error', result);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.catch(error => console.log(error) );\r\n\t}\r\n}","import Template from '../../utils/template';\r\nimport AbstractStep from '../abstractstep';\r\nimport RestProxy from './rest';\r\nimport SiteProxy from './site';\r\n\r\nconst YaPay = window.YaPay;\r\n\r\nexport default class AbstractPayment extends AbstractStep {\r\n\r\n\tstatic defaults = {\r\n\t\ttemplate: '<div class=\"alert alert-success\" role=\"alert\"><strong>#MESSAGE#</strong></div>'\r\n\t}\r\n\r\n\trender(node, data) {\r\n\t\tthis.proxy = this.getOption('isRest')\r\n\t\t\t? new RestProxy(this)\r\n\t\t\t: new SiteProxy(this);\r\n\r\n\t\tconst paymentData = this.getPaymentData(data);\r\n\r\n\t\tthis.createPayment(node, paymentData);\r\n\t}\r\n\r\n\tcompile(data) {\r\n\t\treturn Template.compile(this.options.template, data);\r\n\t}\r\n\r\n\tgetPaymentData(data) {\r\n\t\treturn this.proxy.getPaymentData(data);\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\tthis.proxy.createPayment(node, paymentData);\r\n\t}\r\n}","export default class Proxy {\r\n\r\n\tconstructor(cart) {\r\n\t\tthis.cart = cart;\r\n\t}\r\n\r\n\tgetOption(name) {\r\n\t\treturn this.cart.getOption(name);\r\n\t}\r\n\r\n\tbootstrap() {\r\n\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\r\n\t}\r\n\r\n\tgetPaymentData() {\r\n\r\n\t}\r\n}","import Proxy from \"./proxy\";\r\n\r\nexport default class RestProxy extends Proxy {\r\n\r\n\tbootstrap() {\r\n\t\tthis.reflow();\r\n\t}\r\n\r\n\tgetButtonData() {\r\n\r\n\t\tlet data = {\r\n\t\t\tproductId: this.getOption('productId'),\r\n\t\t\tmode: this.getOption('mode'),\r\n\t\t\tcurrencyCode: this.getOption('currencyCode'),\r\n\t\t\tsetupId: this.getOption('setupId'),\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('restUrl') + 'button/data', data);\r\n\t}\r\n\r\n\tgetPaymentData() {\r\n\t\treturn {\r\n\t\t\tenv: this.getOption('env'),\r\n\t\t\tversion: 3,\r\n\t\t\tmerchantId: this.getOption('merchantId'),\r\n\t\t\tcart: { externalId: \"checkout-b2b-test-order-id\", },\r\n\t\t\tcurrencyCode: this.getOption('currencyCode'),\r\n\t\t}\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\tif (this._mounted != null) { return; }\r\n\r\n\t\tthis._mounted = false;\r\n\r\n\t\tYaPay.createCheckout(paymentData, { agent: { name: \"CMS-Bitrix\", version: \"1.0\" } })\r\n\t\t\t.then((payment) => {\r\n\t\t\t\tthis._mounted = true;\r\n\r\n\t\t\t\tthis.cart.removeLoader();\r\n\t\t\t\tthis.mountButton(node, payment);\r\n\r\n\t\t\t\tpayment.on(YaPay.CheckoutEventType.Success, (event) => {\r\n\r\n\t\t\t\t\tthis.authorize(event)\r\n\t\t\t\t\t\t.then((result) => {\r\n\t\t\t\t\t\t\tif (result.status === 'success') {\r\n\t\t\t\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\t\t\t\twindow.location.href = result.data.redirect;\r\n\t\t\t\t\t\t\t\t}, 1000);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tthis.cart.showError('authorize', result.reasonCode, result.reason);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Success);\r\n\t\t\t\t\tconsole.log(\"Process\", event);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.CheckoutEventType.Error, (event) => {\r\n\t\t\t\t\tconsole.log(\"Process\", event);\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.catch((err) => {\r\n\t\t\t\tthis._mounted = null;\r\n\t\t\t\tnode.remove();\r\n\t\t\t\tthis.cart.showError('yapayPayment','payment not created', err);\r\n\t\t\t});\r\n\t}\r\n\r\n\tauthorize(event) {\r\n\t\tlet data = {\r\n\t\t\torderId: event.orderId,\r\n\t\t\thash: event.metadata,\r\n\t\t\tsuccessUrl: this.getOption('successUrl'),\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('restUrl') + 'authorize', data);\r\n\t}\r\n\r\n\tbindDebug(payment) {\r\n\t\tfor (const key in YaPay.CheckoutEventType) {\r\n\t\t\tif (!YaPay.CheckoutEventType.hasOwnProperty(key)) { continue; }\r\n\r\n\t\t\tpayment.on(YaPay.CheckoutEventType[key], function() {\r\n\t\t\t\tconsole.log(arguments);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tmountButton(node, payment) {\r\n\r\n\t\tthis.payment = payment;\r\n\r\n\t\tpayment.mountButton(this.cart.element, {\r\n\t\t\ttype: YaPay.ButtonType.Checkout,\r\n\t\t\ttheme: this.getOption('buttonTheme') || YaPay.ButtonTheme.Black,\r\n\t\t\twidth: this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto,\r\n\t\t});\r\n\t}\r\n\r\n\trestoreButton(node) {\r\n\t\tif (this.payment == null) {\r\n\t\t\tthis.cart.insertLoader();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.payment.mountButton(node, {\r\n\t\t\ttype: YaPay.ButtonType.Checkout,\r\n\t\t\ttheme: this.getOption('buttonTheme') || YaPay.ButtonTheme.Black,\r\n\t\t\twidth: this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto,\r\n\t\t});\r\n\t}\r\n\r\n\tcombineOrderWithData(data) {\r\n\t\tconst { cart } = this.cart.paymentData;\r\n\r\n\t\tlet exampleData = {\r\n\t\t\tcart: {\r\n\t\t\t\t...cart,\r\n\t\t\t\titems: data.items,\r\n\t\t\t\ttotal: {\r\n\t\t\t\t\tamount: data.total.amount,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tmetadata: data.metadata\r\n\t\t};\r\n\r\n\t\tObject.assign(this.cart.paymentData, exampleData);\r\n\t}\r\n\r\n\tchangeOffer(newProductId) {\r\n\t\tlet productId = this.getOption('productId');\r\n\r\n\t\tif (productId !== newProductId) { // todo in items\r\n\t\t\tthis.cart.widget.setOptions({productId: newProductId});\r\n\t\t\tthis.reflow();\r\n\t\t}\r\n\t}\r\n\r\n\tchangeBasket() {\r\n\t\tthis.reflow();\r\n\t}\r\n\r\n\tsetupPaymentCash(){\r\n\r\n\t}\r\n\r\n\treflow() {\r\n\t\tthis.getButtonData()\r\n\t\t\t.then((result) => {\r\n\t\t\t\tif (result.status === 'fail') { throw new Error(result.reason); }\r\n\r\n\t\t\t\tthis.combineOrderWithData(result.data);\r\n\t\t\t\tthis.createPayment(this.cart.element, this.cart.paymentData);\r\n\t\t\t\tthis.payment?.update(this.cart.paymentData);\r\n\t\t\t})\r\n\t\t\t.catch((error) => {\r\n\t\t\t\tthis.cart.removeLoader();\r\n\t\t\t});\r\n\t}\r\n}","import Proxy from \"./proxy\";\r\n\r\nexport default class SiteProxy extends Proxy {\r\n\r\n\tbootstrap() {\r\n\t\tthis.reflow();\r\n\t}\r\n\r\n\tgetPaymentData() {\r\n\t\treturn {\r\n\t\t\tenv: this.getOption('env'),\r\n\t\t\tversion: 2,\r\n\t\t\tcountryCode: YaPay.CountryCode.Ru,\r\n\t\t\tcurrencyCode: YaPay.CurrencyCode.Rub,\r\n\t\t\tmerchant: {\r\n\t\t\t\tid: this.getOption('merchantId'),\r\n\t\t\t\tname: this.getOption('merchantName'),\r\n\t\t\t\turl: this.getOption('siteUrl')\r\n\t\t\t},\r\n\t\t\torder: { id: '0' },\r\n\t\t\tpaymentMethods: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: YaPay.PaymentMethodType.Card,\r\n\t\t\t\t\tgateway: this.getOption('gateway'),\r\n\t\t\t\t\tgatewayMerchantId: this.getOption('gatewayMerchantId'),\r\n\t\t\t\t\tallowedAuthMethods: [YaPay.AllowedAuthMethod.PanOnly],\r\n\t\t\t\t\tallowedCardNetworks: [\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.UnionPay,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Uzcard,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Discover,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.AmericanExpress,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Visa,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Mastercard,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Mir,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.Maestro,\r\n\t\t\t\t\t\tYaPay.AllowedCardNetwork.VisaElectron\r\n\t\t\t\t\t]\r\n\t\t\t\t}\r\n\t\t\t],\r\n\r\n\t\t\trequiredFields: {\r\n\r\n\t\t\t\tbillingContact: {\r\n\t\t\t\t\temail: this.getOption('useEmail') || false\r\n\t\t\t\t},\r\n\r\n\t\t\t\tshippingContact: {\r\n\t\t\t\t\tname: this.getOption('useName') || false,\r\n\t\t\t\t\temail: this.getOption('useEmail') || false,\r\n\t\t\t\t\tphone: this.getOption('usePhone') || false,\r\n\t\t\t\t},\r\n\r\n\t\t\t\tshippingTypes: {\r\n\t\t\t\t\tdirect: true,\r\n\t\t\t\t\tpickup: true,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetProducts(){\r\n\r\n\t\tlet data = {\r\n\t\t\tyapayAction: 'getProducts',\r\n\t\t\tproductId: this.getOption('productId'),\r\n\t\t\tmode: this.getOption('mode'),\r\n\t\t\tsetupId: this.getOption('setupId')\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('purchaseUrl'), data);\r\n\t}\r\n\r\n\tgetShippingOptions(address) {\r\n\r\n\t\tlet data = {\r\n\t\t\taddress: address,\r\n\t\t\tyapayAction: 'deliveryOptions',\r\n\t\t\titems: this.cart.paymentData.order.items,\r\n\t\t\tsetupId: this.getOption('setupId'),\r\n\t\t\tpaySystemId: this.getOption('paySystemId'),\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('purchaseUrl'), data);\r\n\t}\r\n\r\n\tgetPickupOptions(bounds) {\r\n\r\n\t\tlet data = {\r\n\t\t\tbounds: bounds,\r\n\t\t\tyapayAction: 'pickupOptions',\r\n\t\t\titems: this.cart.paymentData.order.items,\r\n\t\t\tsetupId: this.getOption('setupId'),\r\n\t\t\tpaySystemId: this.getOption('paySystemId'),\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('purchaseUrl'), data);\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\tif (this._mounted != null) { return; }\r\n\r\n\t\tthis._mounted = false;\r\n\r\n\t\tYaPay.createPayment(paymentData, { agent: { name: \"CMS-Bitrix\", version: \"1.0\" } })\r\n\t\t\t.then((payment) => {\r\n\t\t\t\tthis._mounted = true;\r\n\r\n\t\t\t\tthis.cart.removeLoader();\r\n\t\t\t\tthis.cart.mountButton(node, payment);\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Process, (event) => {\r\n\r\n\t\t\t\t\tthis.orderAccept(event).then((result) => {\r\n\r\n\t\t\t\t\t\tif (result.error) { throw new Error(result.error.message, result.error.code); }\r\n\r\n\t\t\t\t\t\tif(!this.isPaymentTypeCash(event)) {\r\n\t\t\t\t\t\t\tthis.notify(result, event).then(result => {\r\n\t\t\t\t\t\t\t\tif (result.success === true) {\r\n\t\t\t\t\t\t\t\t\tthis.cart.widget.go(result.state, result);\r\n\t\t\t\t\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Success);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthis.cart.widget.go('error', result);\r\n\t\t\t\t\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Error);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Success);\r\n\r\n\t\t\t\t\t\t\t\tif (result.redirect != null) {\r\n\t\t\t\t\t\t\t\t\twindow.location.href = result.redirect;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.catch((error) => {\r\n\t\t\t\t\t\t\tthis.cart.showError('yapayProcess', '', error); // todo test it\r\n\t\t\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Error, (event) => {\r\n\t\t\t\t\tthis.cart.showError('yapayError', 'service temporary unavailable');\r\n\t\t\t\t\tpayment.complete(YaPay.CompleteReason.Error);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpayment.on(YaPay.PaymentEventType.Change, (event) => {\r\n\t\t\t\t\t// если выбрали адрес доставки, отдаем скисок доставок\r\n\t\t\t\t\tif (event.shippingAddress) {\r\n\t\t\t\t\t\tthis.getShippingOptions(event.shippingAddress).then((result) => {\r\n\t\t\t\t\t\t\tpayment.update({shippingOptions: result})\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// добавляем выбранную доставку\r\n\t\t\t\t\tif (event.shippingOption){\r\n\t\t\t\t\t\tpayment.update({\r\n\t\t\t\t\t\t\torder: this.combineOrderWithDirectShipping(event.shippingOption),\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// если выбрали ПВЗ, отдаем список ПВЗ\r\n\t\t\t\t\tif (event.pickupBounds) {\r\n\t\t\t\t\t\tthis.getPickupOptions(event.pickupBounds).then((result) => {\r\n\t\t\t\t\t\t\tpayment.update({pickupPoints: result})\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (event.pickupInfo) {\r\n\t\t\t\t\t\tthis.getPickupDetail(event.pickupInfo.pickupPointId).then((result) => {\r\n\t\t\t\t\t\t\tpayment.update({\r\n\t\t\t\t\t\t\t\tpickupPoint: result\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// добавляем выбранный ПВЗ\r\n\t\t\t\t\tif (event.pickupPoint) {\r\n\t\t\t\t\t\tpayment.update({\r\n\t\t\t\t\t\t\torder: this.combineOrderWithPickupShipping(event.pickupPoint),\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.catch((err) => {\r\n\t\t\t\tthis._mounted = null;\r\n\t\t\t\tthis.cart.showError('yapayPayment','payment not created', err);\r\n\t\t\t});\r\n\t}\r\n\r\n\tgetPickupDetail(pickupId) {\r\n\t\tlet data = {\r\n\t\t\tpickupId: pickupId,\r\n\t\t\tyapayAction: 'pickupDetail',\r\n\t\t\titems: this.cart.paymentData.order.items,\r\n\t\t\tsetupId: this.getOption('setupId'),\r\n\t\t\tpaySystemId: this.getOption('paySystemId'),\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('purchaseUrl'), data);\r\n\t}\r\n\r\n\torderAccept(event) {\r\n\r\n\t\tlet deliveryType = event.shippingMethodInfo.shippingOption ? 'delivery' : 'pickup';\r\n\t\tlet delivery;\r\n\r\n\t\tif (deliveryType === 'pickup') {\r\n\t\t\tdelivery = {\r\n\t\t\t\taddress: event.shippingMethodInfo.pickupPoint.address,\r\n\t\t\t\tpickup: event.shippingMethodInfo.pickupPoint,\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tdelivery = {\r\n\t\t\t\taddress: event.shippingMethodInfo.shippingAddress,\r\n\t\t\t\tdelivery: event.shippingMethodInfo.shippingOption,\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet orderData = {\r\n\t\t\tsetupId: this.getOption('setupId'),\r\n\t\t\titems: this.cart.paymentData.order.items,\r\n\t\t\tpayment: event.paymentMethodInfo,\r\n\t\t\tcontact: event.shippingContact,\r\n\t\t\tyapayAction: 'orderAccept',\r\n\t\t\tdeliveryType: deliveryType,\r\n\t\t\tpaySystemId: this.isPaymentTypeCash(event) ? this.getOption('paymentCash') : this.getOption('paySystemId'),\r\n\t\t\torderAmount: event.orderAmount\r\n\t\t};\r\n\r\n\t\tlet data = {...orderData, ...delivery };\r\n\r\n\t\treturn this.cart.query(this.getOption('purchaseUrl'), data);\r\n\t}\r\n\r\n\tisPaymentTypeCash(event) {\r\n\t\treturn (event.paymentMethodInfo.type === 'CASH');\r\n\t}\r\n\r\n\tnotify(payment, yandexPayData) {\r\n\r\n\t\tlet data = {\r\n\t\t\tservice: this.getOption('requestSign'),\r\n\t\t\taccept: 'json',\r\n\t\t\tyandexData: yandexPayData,\r\n\t\t\texternalId: payment.externalId,\r\n\t\t\tpaySystemId: payment.paySystemId\r\n\t\t};\r\n\r\n\t\treturn this.cart.query(this.getOption('notifyUrl'), data);\r\n\t}\r\n\r\n\tchangeOffer(newProductId) {\r\n\t\tlet productId = this.getOption('productId');\r\n\r\n\t\tif (productId !== newProductId) { // todo in items\r\n\t\t\tthis.cart.widget.setOptions({productId: newProductId});\r\n\t\t\tthis.reflow();\r\n\t\t}\r\n\t}\r\n\r\n\tchangeBasket() {\r\n\t\tthis.reflow();\r\n\t}\r\n\r\n\treflow() {\r\n\t\tthis.getProducts()\r\n\t\t\t.then((result) => {\r\n\t\t\t\tif (result.error) { throw new Error(result.error.message); }\r\n\r\n\t\t\t\tthis.combineOrderWithProducts(result);\r\n\t\t\t\tthis.createPayment(this.cart.element, this.cart.paymentData);\r\n\t\t\t})\r\n\t\t\t.catch((error) => {\r\n\t\t\t\tthis.cart.removeLoader();\r\n\t\t\t\t// todo this.showError();\r\n\t\t\t});\r\n\t}\r\n\r\n\tcombineOrderWithPickupShipping(pickupOption) {\r\n\t\tconst { order } = this.cart.paymentData;\r\n\r\n\t\treturn {\r\n\t\t\t...order,\r\n\t\t\titems: [\r\n\t\t\t\t...order.items,\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: 'SHIPPING',\r\n\t\t\t\t\tlabel: pickupOption.label,\r\n\t\t\t\t\tamount: pickupOption.amount,\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t\ttotal: {\r\n\t\t\t\t...order.total,\r\n\t\t\t\tamount: this.cart.amountSum(order.total.amount, pickupOption.amount),\r\n\t\t\t},\r\n\t\t};\r\n\t}\r\n\r\n\tcombineOrderWithDirectShipping(shippingOption) {\r\n\t\tconst { order } = this.cart.paymentData;\r\n\r\n\t\treturn {\r\n\t\t\t...order,\r\n\t\t\titems: [\r\n\t\t\t\t...order.items,\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: 'SHIPPING',\r\n\t\t\t\t\tlabel: shippingOption.label,\r\n\t\t\t\t\tamount: shippingOption.amount,\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t\ttotal: {\r\n\t\t\t\t...order.total,\r\n\t\t\t\tamount: this.cart.amountSum(order.total.amount, shippingOption.amount),\r\n\t\t\t},\r\n\t\t};\r\n\t}\r\n\r\n\tcombineOrderWithProducts(products) {\r\n\t\tconst { order } = this.cart.paymentData;\r\n\r\n\t\tlet exampleOrder = {\r\n\t\t\t...order,\r\n\t\t\titems: products.items,\r\n\t\t\ttotal: {\r\n\t\t\t\tamount: products.amount,\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tObject.assign(this.cart.paymentData.order, exampleOrder);\r\n\t}\r\n\r\n\trestoreButton(node) {\r\n\t\tif (this.cart.paymentButton == null) {\r\n\t\t\tthis.cart.insertLoader();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t//this.removeLoader();\r\n\t\tthis.cart.paymentButton.mount(node);\r\n\t}\r\n\r\n\tsetupPaymentCash(){\r\n\t\t// Указываем возможность оплаты заказа при получении\r\n\t\tif (this.getOption('paymentCash') == null) { return; }\r\n\r\n\t\tthis.cart.paymentData.paymentMethods.push({\r\n\t\t\ttype: YaPay.PaymentMethodType.Cash,\r\n\t\t});\r\n\t}\r\n}","import Template from '../../utils/template';\r\nimport AbstractStep from '../abstractstep';\r\nimport { ready } from \"../../utils/ready\";\r\nimport RestProxy from \"./rest\";\r\nimport SiteProxy from \"./site\";\r\nimport {EventProxy} from \"../../utils/eventproxy\";\r\n\r\nconst YaPay = window.YaPay;\r\n\r\nexport default class AbstractCart extends AbstractStep {\r\n\r\n\tstatic defaults = {\r\n\t\tloaderTemplate: '<div class=\"bx-yapay-skeleton-loading width--#WIDTH#\"></div>',\r\n\t\tloaderSelector: '.bx-yapay-skeleton-loading',\r\n\t}\r\n\r\n\trender(node, data) {\r\n\t\tthis.isBootstrap = false;\r\n\t\tthis.element = node;\r\n\t\tthis.paymentButton = null;\r\n\t\tthis.proxy = this.getOption('isRest')\r\n\t\t\t? new RestProxy(this)\r\n\t\t\t: new SiteProxy(this);\r\n\t\tthis.paymentData = this.getPaymentData();\r\n\r\n\t\tthis.bootSolution();\r\n\t\tthis.insertLoader();\r\n\t\tthis.setupPaymentCash();\r\n\t\tthis.delayBootstrap();\r\n\t}\r\n\r\n\tcompile(data) {\r\n\t\treturn Template.compile(this.options.template, data);\r\n\t}\r\n\r\n\trestore(node) {\r\n\t\tthis.element = node;\r\n\t\tthis.restoreButton(node);\r\n\t}\r\n\r\n\tbootstrap() {\r\n\t\tthis.isBootstrap = true;\r\n\t\tthis.proxy.bootstrap();\r\n\t}\r\n\r\n\tbootSolution() {\r\n\t\tconst solution = this.widget.getSolution();\r\n\r\n\t\tif (solution == null) { return; }\r\n\r\n\t\tsolution.bootCart(this);\r\n\t}\r\n\r\n\tdelayChangeBasket() {\r\n\t\tthis.delay('changeBasket');\r\n\t}\r\n\r\n\tdelayChangeOffer(productId) {\r\n\t\tthis.delay('changeOffer', [productId]);\r\n\t}\r\n\r\n\tdelayBootstrap() {\r\n\t\tready(() => {\r\n\t\t\tthis.delay('bootstrap');\r\n\t\t});\r\n\t}\r\n\r\n\tchangeBasket() {\r\n\t\tif (!this.isBootstrap) { return; }\r\n\t\tthis.proxy?.changeBasket();\r\n\t}\r\n\r\n\tchangeOffer(newProductId) {\r\n\t\tif (this.isBootstrap) {\r\n\t\t\tthis.proxy?.changeOffer(newProductId);\r\n\t\t} else {\r\n\t\t\tthis.widget.setOptions({productId: newProductId});\r\n\t\t}\r\n\t}\r\n\r\n\tsetupPaymentCash(){\r\n\t\tthis.proxy?.setupPaymentCash();\r\n\t}\r\n\r\n\tgetPaymentData() {\r\n\t\treturn this.proxy.getPaymentData();\r\n\t}\r\n\r\n\tcreatePayment(node, paymentData) {\r\n\t\tthis.proxy.createPayment(node, paymentData);\r\n\t}\r\n\r\n\tmountButton(node, payment) {\r\n\t\tthis.paymentButton = payment.createButton({\r\n\t\t\ttype: YaPay.ButtonType.Checkout,\r\n\t\t\ttheme: this.getOption('buttonTheme') || YaPay.ButtonTheme.Black,\r\n\t\t\twidth: this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto,\r\n\t\t});\r\n\r\n\t\tthis.paymentButton.mount(this.element);\r\n\r\n\t\tthis.paymentButton.on(YaPay.ButtonEventType.Click, () => {\r\n\t\t\tpayment.checkout();\r\n\t\t});\r\n\t}\r\n\r\n\trestoreButton(node) {\r\n\t\tthis.proxy.restoreButton(node);\r\n\t}\r\n\r\n\tamountSum(amountA, amountB) {\r\n\t\treturn (Number(amountA) + Number(amountB)).toFixed(2);\r\n\t}\r\n\r\n\tshowError(type, message, err = null) {\r\n\t\tlet notify = type + ' - ' + message;\r\n\r\n\t\tif (err) {\r\n\t\t\tnotify += ' ' + err;\r\n\t\t}\r\n\r\n\t\talert(notify);\r\n\t}\r\n\r\n\tinsertLoader() {\r\n\t\tconst width = this.getOption('buttonWidth') || YaPay.ButtonWidth.Auto;\r\n\r\n\t\tthis.element.innerHTML = Template.compile(this.getOption('loaderTemplate'), {\r\n\t\t\twidth: width.toLowerCase(),\r\n\t\t\tlabel: this.getOption('label'),\r\n\t\t});\r\n\t}\r\n\r\n\tremoveLoader() {\r\n\t\tconst loader = this.element.querySelector(this.getOption('loaderSelector'));\r\n\r\n\t\tif (loader == null) { return; }\r\n\r\n\t\tloader.remove();\r\n\t}\r\n}","export function ready(callback) {\r\n\tif (document.readyState === 'complete' || document.readyState === 'interactive') {\r\n\t\tsetTimeout(callback, 1);\r\n\t} else {\r\n\t\tdocument.addEventListener('DOMContentLoaded', callback);\r\n\t}\r\n}","import StepFactory from './step/factory';\r\nimport SolutionRegistry from \"./solutionregistry\";\r\n\r\nexport default class Widget {\r\n\r\n\tstatic defaults = {}\r\n\r\n\tdefaults;\r\n\toptions;\r\n\tel;\r\n\tstep;\r\n\r\n\t/**\r\n\t * @param {Object<Element>} element\r\n\t * @param {Object} options\r\n\t */\r\n\tconstructor(element, options = {}) {\r\n\t\tthis.defaults = Object.assign({}, this.constructor.defaults);\r\n\t\tthis.options = {};\r\n\t\tthis.el = element;\r\n\r\n\t\tthis.setOptions(options);\r\n\t\tthis.bootSolution();\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Object} data\r\n\t */\r\n\tpayment(data) {\r\n\t\tthis.go('payment', data);\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Object} data\r\n\t */\r\n\tcart(data){\r\n\t\tthis.go('cart', data);\r\n\t}\r\n\r\n\trestore(element) {\r\n\t\tthis.el = element;\r\n\t\tthis.step?.restore(element);\r\n\t}\r\n\r\n\t/**\r\n\t * @param {string} type\r\n\t * @param {Object} data\r\n\t */\r\n\tgo(type, data) {\r\n\t\tthis.step = this.makeStep(type);\r\n\t\tthis.step.render(this.el, data);\r\n\t}\r\n\r\n\t/**\r\n\t * @param {String} type\r\n\t * @returns {AbstractCart|Finish|Step3ds|Payment|Failure}\r\n\t * @throws {Error}\r\n\t */\r\n\tmakeStep(type) {\r\n\t\tconst options = this.getOption(type) || {};\r\n\r\n\t\treturn StepFactory.make(type, this, options);\r\n\t}\r\n\r\n\tgetSolution() {\r\n\t\tconst name = this.getOption('solution');\r\n\t\tconst mode = this.getOption('mode');\r\n\r\n\t\treturn SolutionRegistry.getPage(name, mode);\r\n\t}\r\n\r\n\tbootSolution() {\r\n\t\tconst solution = this.getSolution();\r\n\r\n\t\tif (solution == null) { return; }\r\n\r\n\t\tsolution.bootWidget(this);\r\n\t}\r\n\r\n\textendDefaults(options) {\r\n\t\tthis.defaults = Object.assign(this.defaults, options);\r\n\t}\r\n\r\n\tsetOptions(options) {\r\n\t\tthis.options = Object.assign(this.options, options);\r\n\t}\r\n\r\n\tgetOption(name) {\r\n\t\treturn this.options[name] ?? this.defaults[name];\r\n\t}\r\n}\r\n","import Secure3d from './secure3d';\r\nimport Finish from './finish';\r\nimport Failure from './failure';\r\nimport AbstractPayment from './payment/abstractpayment';\r\nimport AbstractCart from './cart/abstractcart';\r\n\r\nexport default class Factory {\r\n\r\n\t/**\r\n\t * @param {string} type\r\n\t * @param {Widget} widget\r\n\t * @param {Object} options\r\n\t * @returns {AbstractCart|Finish|Step3ds|AbstractPayment|Failure}\r\n\t * @throws {Error}\r\n\t */\r\n\tstatic make(type, widget, options = {}) {\r\n\t\tif (type === '3ds') {\r\n\t\t\treturn new Secure3d(widget, options);\r\n\t\t} else if (type === 'finished') {\r\n\t\t\treturn new Finish(widget, options);\r\n\t\t} else if (type === 'error') {\r\n\t\t\treturn new Failure(widget, options);\r\n\t\t} else if (type === 'payment') {\r\n\t\t\treturn new AbstractPayment(widget, options);\r\n\t\t} else if (type === 'cart') {\r\n\t\t\treturn new AbstractCart(widget, options);\r\n\t\t}\r\n\r\n\t\tthrow new Error('unknown step ' + type);\r\n\t}\r\n\r\n}"],"names":["SolutionRegistry","static","name","factory","window","_window","BX","_window$BX","YandexPay","_window$BX$YandexPay","Solution","_window$BX$YandexPay$","_window$BX$YandexPay$2","console","warn","mode","key","this","pages","createPage","getFactory","create","MutationSkeleton","constructor","element","options","el","Object","assign","defaults","destroy","check","MutationLoop","super","loop","loopTimeout","loopCancel","clearTimeout","_loopTimeout","setTimeout","timeout","MutationObserver","listener","mutations","mutation","removedNodes","removedNode","HTMLElement","contains","runCheck","observe","disconnect","anchor","getAnchor","observer","childList","subtree","delay","_checkTimeout","document","body","closest","EventProxy","config","callbackMap","on","callback","matchEvent","onBxEvent","onJQueryEvent","onPlainEvent","off","offBxEvent","offJQueryEvent","offPlainEvent","fire","data","fireBxEvent","fireJQueryEvent","firePlainEvent","type","addCustomEvent","removeCustomEvent","onCustomEvent","jQuery","selfConfig","typeConfig","canProxyCallback","originalCallback","evt","proxyData","originalEvent","_evt$originalEvent","detail","pushCallbackVariation","popCallbackVariation","hasPlainAndJQueryCollision","triggerHandler","CustomEvent","addEventListener","removeEventListener","dispatchEvent","proxy","WeakMap","set","map","result","get","delete","Subscriber","eventProxy","bind","unbind","bindOn","bindEvent","unbindOff","unbindEvent","event","Array","isArray","forEach","one","NodePreserver","found","restore","install","uninstall","installMutation","installSubscriber","uninstallMutation","uninstallSubscriber","isEnabled","make","driverOptions","subscriber","option","overrides","Template","template","vars","replaceKey","replaceValue","hasOwnProperty","toUpperCase","replace","indexOf","html","context","createElement","innerHTML","firstElementChild","children","Factory","waitCount","setOptions","bootSolution","bootLocal","inject","selector","position","Promise","resolve","then","waitElement","checkElement","renderElement","widget","getOption","preserve","querySelector","containsSiblingElement","Error","next","parentElement","_anchor$parentElement","matches","nextElementSibling","preserver","preserveOptions","preserveOption","Widget","reject","waitElementLoop","findElement","elementList","variant","trim","searchBySelector","searchById","searchByClassName","length","reduceVisible","part","split","partSanitized","isCssSelector","collection","querySelectorAll","push","e","getElementById","getElementsByClassName","testVisible","offsetWidth","offsetHeight","getClientRects","test","width","YaPay","ButtonWidth","Auto","Utils","compile","label","toLowerCase","elements","toElements","reverse","insertAdjacentElement","solution","getPage","bootFactory","extendDefaults","containerSelector","waitLimit","waitTimeout","AbstractStep","delayTimeouts","render","node","query","url","fetch","method","headers","JSON","stringify","response","json","getTemplate","optionKey","optionFirstSymbol","substr","getNode","getElement","getElementSelector","clearDelay","args","showError","message","err","notify","alert","Base","setWidget","Form","autosubmit","inputs","makeInputs","value","params","keys","termUrl","makeTermUrl","backUrl","location","href","encodeURIComponent","submit","Iframe","insertIframe","iframe","contentIframe","contentWindow","contentDocument","open","write","close","IframeRbs","renderIframe","service","accept","secure","externalId","paySystemId","success","go","state","catch","error","log","action","Step3ds","view","makeView","SecureForm","SecureIframe","SecureRbs","Finish","Failure","Proxy","order","createPayment","paymentData","getPaymentData","RestProxy","env","version","currencyCode","CurrencyCode","Rub","merchantId","orderId","id","cart","items","total","amount","metadata","agent","payment","mountButton","ButtonType","Pay","theme","ButtonTheme","Black","CheckoutEventType","Success","remove","authorize","status","redirect","reasonCode","reason","complete","CompleteReason","Abort","hash","successUrl","SiteProxy","countryCode","CountryCode","Ru","merchant","paymentMethods","PaymentMethodType","Card","gateway","gatewayMerchantId","allowedAuthMethods","AllowedAuthMethod","PanOnly","allowedCardNetworks","AllowedCardNetwork","UnionPay","Uzcard","Discover","AmericanExpress","Visa","Mastercard","Mir","Maestro","VisaElectron","button","createButton","mount","ButtonEventType","Click","checkout","PaymentEventType","Process","errors","yandexPayData","yandexData","AbstractPayment","bootstrap","reflow","getButtonData","productId","setupId","_mounted","createCheckout","removeLoader","bindDebug","arguments","Checkout","restoreButton","insertLoader","combineOrderWithData","exampleData","changeOffer","newProductId","changeBasket","setupPaymentCash","update","requiredFields","billingContact","email","shippingContact","phone","shippingTypes","direct","pickup","getProducts","yapayAction","getShippingOptions","address","getPickupOptions","bounds","orderAccept","code","isPaymentTypeCash","Change","shippingAddress","shippingOptions","shippingOption","combineOrderWithDirectShipping","pickupBounds","pickupPoints","pickupInfo","getPickupDetail","pickupPointId","pickupPoint","combineOrderWithPickupShipping","pickupId","delivery","deliveryType","shippingMethodInfo","paymentMethodInfo","contact","orderAmount","combineOrderWithProducts","pickupOption","amountSum","products","exampleOrder","paymentButton","Cash","AbstractCart","isBootstrap","delayBootstrap","getSolution","bootCart","delayChangeBasket","delayChangeOffer","readyState","amountA","amountB","Number","toFixed","loader","loaderTemplate","loaderSelector","step","makeStep","Secure3d","bootWidget"],"mappings":"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"}