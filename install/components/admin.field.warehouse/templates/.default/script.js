this.BX=this.BX||{},this.BX.YandexPay=this.BX.YandexPay||{},this.BX.YandexPay.Ui=this.BX.YandexPay.Ui||{},function(t){"use strict";class e{static getInstance(){return null==this.instance&&(this.instance=new this),this.instance}constructor(t={}){this.options=Object.assign({},this.constructor.defaults,t)}load(t){if(null!=this._loadPromise)return this._loadPromise;const e=this.loaded();return null!=e?Promise.resolve(e):(this._loadElapsed=0,this._loadPromise=new Promise(((e,s)=>{this.injectScript(t),this.waitLoaded(e,s)})),this._loadPromise.finally((()=>{this._loadPromise=null})),this._loadPromise)}loaded(){var t;return null==(null==(t=window.ymaps)?void 0:t.Map)?null:window.ymaps}injectScript(t){const e=window.document.head||window.document.body||window.document.documentElement,s=document.createElement("script");s.src=this.options.scriptUrl+"&apikey="+encodeURIComponent(t),e.appendChild(s),s.onload=()=>{e.removeChild(s)}}waitLoaded(t,e){const s=this.loaded();null==s?(this._loadElapsed>this.options.loadTimeout&&e(new Error("cant load ymaps")),setTimeout((()=>{this.waitLoaded(t,e)}),this.options.loadStep),this._loadElapsed+=this.options.loadStep):t(s)}}e.defaults={scriptUrl:"https://api-maps.yandex.ru/2.1?lang=ru&wizard=bitrix&load=package.full&mode=release",loadStep:100,loadTimeout:3e4};class s extends BX.ui.autoComplete{constructor(t){super(t.widget),this.selectItem=t=>{super.selectItem(t),this.onSelect(t)},this.onSelect=t.onSelect,this.search=t.search}handleInitStack(t,e,s){this.setOptions(),super.handleInitStack(t,e,s)}setOptions(){BX.merge(this,{opts:{messages:{nothingFound:BX.message("YAPAY_FIELD_WAREHOUSE_SUGGEST_NOTING_FOUND"),error:BX.message("YAPAY_FIELD_WAREHOUSE_SUGGEST_ERROR")},bindEvents:{init:function(){}}},sys:{code:"yapay-suggest"}})}downloadBundle(t,e,s,i){this.search(t,e,s,i)}showLoading(){this.vars.loader.show()}hideLoading(){this.vars.loader.hide()}showError(t,e,s){""===t&&(t=this.opts.messages.error),super.showError(t,e,s)}}class i{constructor(t,e={}){this._itemsData={},this.onMapDoubleClick=t=>{const e=t.get("coords");this.drawPlacemark(e),this.fillCoordinates(e),ymaps.geocode(e).then((t=>{const e=t.geoObjects.get(0),s=this.geoObjectTitle(e),i=this.geoObjectAddress(e);this.fillSuggest(s),this.fillAddress(i)}))},this.onSuggestSelect=t=>{if(null==this._itemsData[t])throw new Error("cant find associated data for item");const e=this._itemsData[t];this.fillAddress(e.address),this.fillCoordinates(e.coordinates),this.drawPlacemark(e.coordinates),this.moveCenter(e.coordinates)},this.onSuggestSearch=(t,e,s,i)=>{this.widget.showLoading(),ymaps.geocode(t.QUERY).then((t=>{this.widget.hideLoading();const i=[];this._itemsData={};for(let e=0;e<t.geoObjects.getLength();e++){const s=t.geoObjects.get(e),o=this.geoObjectTitle(s);i.push({VALUE:o,DISPLAY:o}),this._itemsData[o]={coordinates:this.geoObjectCoordinates(s),address:this.geoObjectAddress(s)}}e.apply(this.widget,[i]),s.call(this.widget)})).catch((t=>{this.widget.hideLoading(),this.widget.showError("",!1,t),s.call(this.widget),BX.type.isFunction(i)&&i.call(this.widget)}))},this.$el=t,this.el=this.$el[0],this.options=Object.assign({},this.constructor.defaults,e),this.initialize()}initialize(){this.bootWidget(),this.bind()}bind(){this.handleMapDoubleClick(!0)}handleMapDoubleClick(t){this.options.map.events[t?"add":"remove"]("dblclick",this.onMapDoubleClick)}bootWidget(){this.widget=new s({widget:{scope:this.el},onSelect:this.onSuggestSelect,search:this.onSuggestSearch})}geoObjectCoordinates(t){return t.geometry.getCoordinates()}geoObjectTitle(t){return t.properties.get("metaDataProperty").GeocoderMetaData.text}geoObjectAddress(t){const e=t.properties.get("metaDataProperty").GeocoderMetaData.Address.Components,s={country:"COUNTRY",street:"STREET",district:"STREET",house:"BUILDING",locality:"LOCALITY"},i={};for(let t=0;t<e.length;t++){const o=e[t],a=s[o.kind];null!=a&&(i[a]=o.name)}return i}fillSuggest(t){this.$el.find('input[data-name="WAREHOUSE"]').val(t)}fillAddress(t){for(const[e,s]of Object.entries(t))this.options.details.find(`input[data-name="${e}"]`).val(s)}fillCoordinates(t){this.options.details.find('input[data-name="LOCATION_LAT"]').val(t[0]),this.options.details.find('input[data-name="LOCATION_LON"]').val(t[1])}drawPlacemark(t){this.options.map.geoObjects.removeAll(),this.options.map.geoObjects.add(new ymaps.Placemark(t))}moveCenter(t){this.options.map.setCenter(t)}}i.defaults={};class o extends BX.YandexPay.Plugin.Base{constructor(...t){super(...t),this.onDialogResize=()=>{const t=this.$el.closest(this.options.dialogElement);0!==t.length&&(this.$el.width(t.width()-1),this.$el.height(t.height()-1),this._map.container.fitToViewport())},this.onClarifyClick=()=>{this.toggleDetails()},this.searchStop=t=>{},this.searchEnd=t=>{console.log(t)},this.postInitialize()}destroy(){this.unbind(),super.destroy()}postInitialize(){this.bind(),e.getInstance().load(this.options.apiKey).then((()=>{this.bootMap(),this.bootSuggest()}))}bind(){this.handleClarifyClick(!0),this.handleDialogResize(!0)}unbind(){this.handleClarifyClick(!1),this.handleDialogResize(!1)}handleClarifyClick(t){this.getElement("clarify")[t?"on":"off"]("click",this.onClarifyClick)}handleDialogResize(t){BX[t?"addCustomEvent":"removeCustomEvent"]("onWindowResize",this.onDialogResize)}toggleDetails(){const t=this.getElement("clarify"),e=t.data("alt");t.data("alt",t.html()),t.html(e);const s=this.getElement("details").find("input"),i=s.prop("readonly");s.prop("readonly",!i)}bootMap(){const t=this.getElement("map");return this._map=new ymaps.Map(t[0],{center:[55.76,37.64],controls:["zoomControl"],behaviors:["drag","scrollZoom","multiTouch"],zoom:10},{yandexMapDisablePoiInteractivity:!0}),this._map}bootSuggest(){const t=this.getElement("suggest");this._suggest=new i(t,{map:this._map,details:this.getElement("details")})}search(){const t=this.getElement("suggest").val();this._mapLibrary.geocode(t).then(this.searchEnd,this.searchStop)}}o.defaults={mapElement:".js-field-warehouse__map",suggestElement:".js-field-warehouse__suggest",clarifyElement:".js-field-warehouse__clarify",detailsElement:".js-field-warehouse__details",dialogElement:".bx-core-adm-dialog-content",apiKey:null},o.dataName="uiFieldWarehouse",t.Warehouse=o}(this.BX.YandexPay.Ui.Field=this.BX.YandexPay.Ui.Field||{});
//# sourceMappingURL=script.js.map
