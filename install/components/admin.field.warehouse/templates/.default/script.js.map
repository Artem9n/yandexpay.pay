{"version":3,"file":"script.js","sources":["src/mapsLoader.js","src/suggestwidget.js","src/suggest.js","src/index.js"],"sourcesContent":["export class MapsLoader {\r\n\r\n\tstatic instance;\r\n\r\n\tstatic defaults = {\r\n\t\tscriptUrl: 'https://enterprise.api-maps.yandex.ru/2.0/?load=package.full&mode=release&lang=ru&wizard=bitrix', // todo locale and wizard\r\n\t\tloadStep: 100,\r\n\t\tloadTimeout: 30000,\r\n\t};\r\n\r\n\t_loadPromise;\r\n\t_loadElapsed;\r\n\r\n\tstatic getInstance() : MapsLoader {\r\n\t\tif (this.instance == null) {\r\n\t\t\tthis.instance = new this();\r\n\t\t}\r\n\r\n\t\treturn this.instance;\r\n\t}\r\n\r\n\tconstructor(options: Object = {}) {\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\t}\r\n\r\n\tload(apiKey: string) : Promise {\r\n\t\tif (this._loadPromise != null) { return this._loadPromise; }\r\n\r\n\t\tconst loaded = this.loaded();\r\n\r\n\t\tif (loaded != null) { return Promise.resolve(loaded); }\r\n\r\n\t\tthis._loadElapsed = 0;\r\n\t\tthis._loadPromise = new Promise((resolve, reject) => {\r\n\t\t\tthis.injectScript(apiKey);\r\n\t\t\tthis.waitLoaded(resolve, reject);\r\n\t\t});\r\n\r\n\t\tthis._loadPromise.finally(() => {\r\n\t\t\tthis._loadPromise = null;\r\n\t\t})\r\n\r\n\t\treturn this._loadPromise;\r\n\t}\r\n\r\n\tloaded() {\r\n\t\tif (window.ymaps?.Map == null) { return null; }\r\n\r\n\t\treturn window.ymaps;\r\n\t}\r\n\r\n\tinjectScript(apiKey: string) : void {\r\n\t\tconst anchor = window.document.head || window.document.body || window.document.documentElement;\r\n\t\tconst script = document.createElement('script');\r\n\r\n\t\tscript.src = this.options.scriptUrl + '&apikey=' + encodeURIComponent(apiKey);\r\n\r\n\t\tanchor.appendChild(script);\r\n\r\n\t\tscript.onload = () => {\r\n\t\t\tanchor.removeChild(script);\r\n\t\t};\r\n\t}\r\n\r\n\twaitLoaded(resolve, reject) : void {\r\n\t\tconst loaded = this.loaded();\r\n\r\n\t\tif (loaded != null) {\r\n\t\t\tresolve(loaded);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (this._loadElapsed > this.options.loadTimeout) {\r\n\t\t\treject(new Error('cant load ymaps')); // todo lang message\r\n\t\t}\r\n\r\n\t\tsetTimeout(\r\n\t\t\t() => { this.waitLoaded(resolve, reject) },\r\n\t\t\tthis.options.loadStep\r\n\t\t);\r\n\r\n\t\tthis._loadElapsed += this.options.loadStep;\r\n\t}\r\n\r\n}","export class SuggestWidget extends BX.ui.autoComplete {\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options.widget);\r\n\t\tthis.options = options;\r\n\t}\r\n\r\n\tdownloadBundle(request, onLoad, onComplete, onError) {\r\n\t\tymaps.geocode(request['QUERY'])\r\n\t\t\t.then((response) => {\r\n\r\n\t\t\t\tlet so = this.opts, sv = this.vars, sc = this.ctrls, ctx = this;\r\n\r\n\t\t\t\tsv.loader.show();\r\n\r\n\t\t\t\tlet len = response.geoObjects.getLength();\r\n\t\t\t\tlet text, geo ,result = [];\r\n\r\n\t\t\t\tfor (let i = 0; i < len; i++) {\r\n\r\n\t\t\t\t\ttext = response.geoObjects.get(i).properties.get('metaDataProperty').GeocoderMetaData.text;\r\n\t\t\t\t\tgeo = response.geoObjects.get(i).properties.get('boundedBy');\r\n\r\n\t\t\t\t\tresult[i] = {\r\n\t\t\t\t\t\tVALUE: geo,\r\n\t\t\t\t\t\tDISPLAY: text,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log(result);\r\n\r\n\t\t\t\tonLoad.apply(ctx, [result]);\r\n\t\t\t\tonComplete.call(ctx);\r\n\r\n\t\t\t\tconsole.log(response);\r\n\t\t\t});\r\n\t}\r\n\r\n\t// invokes when user selects value\r\n\tselectItem = (value) => {\r\n\t\tsuper.selectItem(value);\r\n\r\n\t\tconsole.log(this);\r\n\r\n\t\tlet myPlacemark = new ymaps.Placemark(value, {\r\n\t\t\tballoonContentHeader: 'test',\r\n\t\t\tballoonContent: 'test',\r\n\t\t\tballoonContentFooter: 'test'\r\n\t\t}, {\r\n\t\t\tpreset: 'islands#blueDotIcon'\r\n\t\t});\r\n\r\n\t\tthis.options.map.geoObjects.add(myPlacemark);\r\n\t\tthis.options.map.setBounds(value, {checkZoomRange:true, zoomMargin:9});\r\n\t\t//this.options.map.setBounds(this.options.map.geoObjects.getBounds(),{checkZoomRange:true, zoomMargin:9});\r\n\r\n\r\n\t\t//ymaps.setBounds(value, { checkZoomRange: true });\r\n\t}\r\n\r\n}\r\n","import {SuggestWidget} from \"./suggestwidget\";\r\n\r\nexport class Suggest {\r\n\r\n\tstatic defaults = {\r\n\r\n\t};\r\n\r\n\tconstructor(element: $, options: Object = {}) {\r\n\t\tthis.$el = element;\r\n\t\tthis.el = this.$el[0];\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\r\n\t\tthis.initialize();\r\n\t}\r\n\r\n\tinitialize() {\r\n\t\tthis.widget = new SuggestWidget({\r\n\t\t\twidget: {\r\n\t\t\t\tscope: this.el\r\n\t\t\t},\r\n\t\t\tmap: this.options.map\r\n\t\t});\r\n\r\n\t\tconsole.log(this.widget);\r\n\t}\r\n\r\n}","import {MapsLoader} from \"./mapsLoader\";\r\nimport {Suggest} from \"./suggest\";\r\n\r\nexport class Warehouse extends BX.YandexPay.Plugin.Base {\r\n\r\n\tstatic defaults = {\r\n\t\tmapElement: '.js-field-warehouse__map',\r\n\t\tsuggestElement: '.js-field-warehouse__suggest',\r\n\t\tapiKey: null,\r\n\t};\r\n\r\n\tstatic dataName = 'uiFieldWarehouse';\r\n\r\n\tinitialize() {\r\n\t\tsuper.initialize();\r\n\r\n\t\tMapsLoader.getInstance().load(this.options.apiKey)\r\n\t\t\t.then(() => {\r\n\t\t\t\tthis.bootMap();\r\n\t\t\t\tthis.bootSuggest();\r\n\t\t\t});\r\n\t}\r\n\r\n\tbootMap() {\r\n\t\tconst element = this.getElement('map');\r\n\r\n\t\tthis._map = new ymaps.Map(element[0], {\r\n\t\t\tcenter: [55.76, 37.64],\r\n\t\t\tcontrols: ['zoomControl'],\r\n\t\t\tzoom: 10\r\n\t\t});\r\n\r\n\t\treturn this._map;\r\n\t}\r\n\r\n\tbootSuggest() {\r\n\t\tconst element = this.getElement('suggest');\r\n\r\n\t\tthis._suggest = new Suggest(element, {\r\n\t\t\tmap: this._map,\r\n\t\t});\r\n\t}\r\n\r\n\tsearch() {\r\n\t\tconst suggest = this.getElement('suggest');\r\n\t\tconst query = suggest.val();\r\n\r\n\t\tthis._mapLibrary.geocode(query).then(\r\n\t\t\tthis.searchEnd,\r\n\t\t\tthis.searchStop\r\n\t\t);\r\n\t}\r\n\r\n\tsearchStop = (error: Error) => {\r\n\t\t// todo handle error\r\n\t}\r\n\r\n\tsearchEnd = (response: Object) => {\r\n\t\tconsole.log(response);\r\n\t}\r\n\r\n}"],"names":["MapsLoader","this","instance","constructor","options","Object","assign","defaults","load","apiKey","_loadPromise","loaded","Promise","resolve","_loadElapsed","reject","injectScript","waitLoaded","finally","window","ymaps","Map","anchor","document","head","body","documentElement","script","createElement","src","scriptUrl","encodeURIComponent","appendChild","onload","removeChild","loadTimeout","Error","setTimeout","loadStep","SuggestWidget","BX","ui","autoComplete","widget","selectItem","value","console","log","myPlacemark","Placemark","balloonContentHeader","balloonContent","balloonContentFooter","preset","map","geoObjects","add","setBounds","checkZoomRange","zoomMargin","downloadBundle","request","onLoad","onComplete","onError","geocode","then","response","opts","sv","vars","ctrls","loader","show","text","geo","len","getLength","result","i","get","properties","GeocoderMetaData","VALUE","DISPLAY","apply","call","Suggest","element","$el","el","initialize","scope","Warehouse","YandexPay","Plugin","Base","searchStop","error","searchEnd","getInstance","bootMap","bootSuggest","getElement","_map","center","controls","zoom","_suggest","search","query","val","_mapLibrary","mapElement","suggestElement","dataName"],"mappings":"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"}