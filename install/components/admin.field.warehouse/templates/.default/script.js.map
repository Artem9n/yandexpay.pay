{"version":3,"file":"script.js","sources":["src/mapsLoader.js","src/suggestwidget.js","src/suggest.js","src/index.js"],"sourcesContent":["export class MapsLoader {\r\n\r\n\tstatic instance;\r\n\r\n\tstatic defaults = {\r\n\t\tscriptUrl: 'https://api-maps.yandex.ru/2.1?lang=ru&wizard=bitrix&load=package.full&mode=release', // todo locale and wizard\r\n\t\tloadStep: 100,\r\n\t\tloadTimeout: 30000,\r\n\t};\r\n\r\n\t_loadPromise;\r\n\t_loadElapsed;\r\n\r\n\tstatic getInstance() : MapsLoader {\r\n\t\tif (this.instance == null) {\r\n\t\t\tthis.instance = new this();\r\n\t\t}\r\n\r\n\t\treturn this.instance;\r\n\t}\r\n\r\n\tconstructor(options: Object = {}) {\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\t}\r\n\r\n\tload(apiKey: string) : Promise {\r\n\t\tif (this._loadPromise != null) { return this._loadPromise; }\r\n\r\n\t\tconst loaded = this.loaded();\r\n\r\n\t\tif (loaded != null) { return Promise.resolve(loaded); }\r\n\r\n\t\tthis._loadElapsed = 0;\r\n\t\tthis._loadPromise = new Promise((resolve, reject) => {\r\n\t\t\tthis.injectScript(apiKey);\r\n\t\t\tthis.waitLoaded(resolve, reject);\r\n\t\t});\r\n\r\n\t\tthis._loadPromise.finally(() => {\r\n\t\t\tthis._loadPromise = null;\r\n\t\t})\r\n\r\n\t\treturn this._loadPromise;\r\n\t}\r\n\r\n\tloaded() {\r\n\t\tif (window.ymaps?.Map == null) { return null; }\r\n\r\n\t\treturn window.ymaps;\r\n\t}\r\n\r\n\tinjectScript(apiKey: string) : void {\r\n\t\tconst anchor = window.document.head || window.document.body || window.document.documentElement;\r\n\t\tconst script = document.createElement('script');\r\n\r\n\t\tscript.src = this.options.scriptUrl + '&apikey=' + encodeURIComponent(apiKey);\r\n\r\n\t\tanchor.appendChild(script);\r\n\r\n\t\tscript.onload = () => {\r\n\t\t\tanchor.removeChild(script);\r\n\t\t};\r\n\t}\r\n\r\n\twaitLoaded(resolve, reject) : void {\r\n\t\tconst loaded = this.loaded();\r\n\r\n\t\tif (loaded != null) {\r\n\t\t\tresolve(loaded);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (this._loadElapsed > this.options.loadTimeout) {\r\n\t\t\treject(new Error('cant load ymaps')); // todo lang message\r\n\t\t}\r\n\r\n\t\tsetTimeout(\r\n\t\t\t() => { this.waitLoaded(resolve, reject) },\r\n\t\t\tthis.options.loadStep\r\n\t\t);\r\n\r\n\t\tthis._loadElapsed += this.options.loadStep;\r\n\t}\r\n\r\n}","import \"./suggestwidget.css\";\r\n\r\nexport class SuggestWidget extends BX.ui.autoComplete {\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options.widget);\r\n\r\n\t\tthis.onSelect = options.onSelect;\r\n\t\tthis.search = options.search;\r\n\t}\r\n\thandleInitStack(nf, owner, opts) {\r\n\t\tthis.sys.code = 'yapay-suggest';\r\n\t\tsuper.handleInitStack(nf, owner, opts);\r\n\t}\r\n\r\n\tdownloadBundle(request, onLoad, onComplete, onError) {\r\n\t\tthis.search(request, onLoad, onComplete, onError);\r\n\t}\r\n\r\n\t// invokes when user selects value\r\n\tselectItem = (value) => {\r\n\t\tsuper.selectItem(value);\r\n\t\tthis.onSelect(value);\r\n\t}\r\n\r\n}\r\n","import {SuggestWidget} from \"./suggestwidget\";\r\n\r\nexport class Suggest {\r\n\r\n\tstatic defaults = {\r\n\r\n\t};\r\n\r\n\tconstructor(element: $, options: Object = {}) {\r\n\t\tthis.$el = element;\r\n\t\tthis.el = this.$el[0];\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\r\n\r\n\t\tthis.initialize();\r\n\t}\r\n\r\n\tinitialize() {\r\n\t\tthis.widget = new SuggestWidget({\r\n\t\t\twidget: {\r\n\t\t\t\tscope: this.el\r\n\t\t\t},\r\n\t\t\tonSelect: this.onSelect,\r\n\t\t\tsearch: this.search\r\n\t\t});\r\n\r\n\r\n\t\tthis.options.map.events.add(\"dblclick\", (e) => {\r\n\r\n\t\t\tif (this.placemark != null)\r\n\t\t\t{\r\n\t\t\t\tthis.options.map.geoObjects.remove(this.placemark);\r\n\t\t\t}\r\n\r\n\t\t\tlet coords = e.get('coords');\r\n\r\n\t\t\tymaps.geocode(coords)\r\n\t\t\t\t.then((response) => {\r\n\t\t\t\t\tlet text = response.geoObjects.get(0).properties.get('metaDataProperty').GeocoderMetaData.text;\r\n\t\t\t\t\t$('[data-name=\"WAREHOUSE\"]').val(text);\r\n\t\t\t\t});\r\n\r\n\t\t\tthis.onSelect(coords);\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect = (value) => {\r\n\r\n\t\tymaps.geocode(value).then((res) => {\r\n\r\n\t\t\tlet geoObj = res.geoObjects.get(0);\r\n\t\t\tlet address = geoObj.properties.get('metaDataProperty').GeocoderMetaData.Address.Components;\r\n\t\t\tlet coordinates = geoObj.geometry.getCoordinates();\r\n\t\t\tlet bounds = geoObj.properties.get('boundedBy');\r\n\r\n\t\t\tfor (let i = 0; i < address.length; i++)\r\n\t\t\t{\r\n\t\t\t\tlet test = address[i];\r\n\r\n\t\t\t\tif (test.kind === 'country')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('input[name*=\"COUNTRY\"]').val(test.name);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (test.kind === 'street' || test.kind === 'district')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('input[name*=\"STREET\"]').val(test.name);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (test.kind === 'house')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('input[name*=\"BUILDING\"]').val(test.name);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (test.kind === 'locality')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('input[name*=\"LOCALITY\"]').val(test.name);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$('input[name*=\"LOCATION_LAT\"]').val(coordinates[0]);\r\n\t\t\t$('input[name*=\"LOCATION_LON\"]').val(coordinates[1]);\r\n\r\n\t\t\tif (this.placemark != null)\r\n\t\t\t{\r\n\t\t\t\tthis.options.map.geoObjects.remove(this.placemark);\r\n\t\t\t}\r\n\r\n\t\t\tthis.placemark = new ymaps.Placemark(coordinates, {\r\n\t\t\t\tballoonContentHeader: 'test',\r\n\t\t\t}, {\r\n\t\t\t\tpreset: 'islands#blueDotIcon'\r\n\t\t\t});\r\n\r\n\t\t\tthis.options.map.geoObjects.add(this.placemark);\r\n\t\t\tthis.options.map.setBounds(coordinates, {checkZoomRange:true, zoomMargin:5});\r\n\t\t});\r\n\t}\r\n\r\n\tsearch(request, onLoad, onComplete, onError){\r\n\t\tymaps.geocode(request['QUERY'])\r\n\t\t\t.then((response) => {\r\n\r\n\t\t\t\tlet so = this.opts, sv = this.vars, sc = this.ctrls, ctx = this;\r\n\r\n\t\t\t\tsv.loader.show();\r\n\r\n\t\t\t\tlet len = response.geoObjects.getLength();\r\n\t\t\t\tlet text, geo ,result = [];\r\n\r\n\t\t\t\tfor (let i = 0; i < len; i++) {\r\n\r\n\t\t\t\t\ttext = response.geoObjects.get(i).properties.get('metaDataProperty').GeocoderMetaData.text;\r\n\t\t\t\t\tgeo = response.geoObjects.get(i).properties.get('boundedBy');\r\n\r\n\t\t\t\t\tresult[i] = {\r\n\t\t\t\t\t\tVALUE: text,\r\n\t\t\t\t\t\tDISPLAY: text,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tonLoad.apply(ctx, [result]);\r\n\t\t\t\tonComplete.call(ctx);\r\n\t\t\t});\r\n\t}\r\n\r\n}","import {MapsLoader} from \"./mapsLoader\";\r\nimport {Suggest} from \"./suggest\";\r\n\r\nexport class Warehouse extends BX.YandexPay.Plugin.Base {\r\n\r\n\tstatic defaults = {\r\n\t\tmapElement: '.js-field-warehouse__map',\r\n\t\tsuggestElement: '.js-field-warehouse__suggest',\r\n\t\tapiKey: null,\r\n\t};\r\n\r\n\tstatic dataName = 'uiFieldWarehouse';\r\n\r\n\tinitialize() {\r\n\t\tsuper.initialize();\r\n\r\n\t\tMapsLoader.getInstance().load(this.options.apiKey)\r\n\t\t\t.then(() => {\r\n\t\t\t\tthis.bootMap();\r\n\t\t\t\tthis.bootSuggest();\r\n\t\t\t});\r\n\t}\r\n\r\n\tbootMap() {\r\n\t\tconst element = this.getElement('map');\r\n\r\n\t\tthis._map = new ymaps.Map(element[0], {\r\n\t\t\tcenter: [55.76, 37.64],\r\n\t\t\tcontrols: ['zoomControl'],\r\n\t\t\tzoom: 10\r\n\t\t});\r\n\r\n\t\treturn this._map;\r\n\t}\r\n\r\n\tbootSuggest() {\r\n\t\tconst element = this.getElement('suggest');\r\n\r\n\t\tthis._suggest = new Suggest(element, {\r\n\t\t\tmap: this._map,\r\n\t\t});\r\n\t}\r\n\r\n\tsearch() {\r\n\t\tconst suggest = this.getElement('suggest');\r\n\t\tconst query = suggest.val();\r\n\r\n\t\tthis._mapLibrary.geocode(query).then(\r\n\t\t\tthis.searchEnd,\r\n\t\t\tthis.searchStop\r\n\t\t);\r\n\t}\r\n\r\n\tsearchStop = (error: Error) => {\r\n\t\t// todo handle error\r\n\t}\r\n\r\n\tsearchEnd = (response: Object) => {\r\n\t\tconsole.log(response);\r\n\t}\r\n\r\n}"],"names":["MapsLoader","static","this","instance","constructor","options","Object","assign","defaults","load","apiKey","_loadPromise","loaded","Promise","resolve","_loadElapsed","reject","injectScript","waitLoaded","finally","window","ymaps","Map","anchor","document","head","body","documentElement","script","createElement","src","scriptUrl","encodeURIComponent","appendChild","onload","removeChild","loadTimeout","Error","setTimeout","loadStep","SuggestWidget","BX","ui","autoComplete","super","widget","selectItem","value","onSelect","search","handleInitStack","nf","owner","opts","sys","code","downloadBundle","request","onLoad","onComplete","onError","Suggest","element","geocode","then","res","geoObj","geoObjects","get","address","properties","GeocoderMetaData","Address","Components","coordinates","geometry","getCoordinates","i","length","test","kind","$","val","name","placemark","map","remove","Placemark","balloonContentHeader","preset","add","setBounds","checkZoomRange","zoomMargin","$el","el","initialize","scope","events","e","coords","response","text","sv","vars","ctrls","loader","show","geo","len","getLength","result","VALUE","DISPLAY","apply","call","Warehouse","YandexPay","Plugin","Base","searchStop","error","searchEnd","console","log","getInstance","bootMap","bootSuggest","getElement","_map","center","controls","zoom","_suggest","query","_mapLibrary","mapElement","suggestElement","dataName"],"mappings":"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"}